name: Deploy Azure Functions

on:
  push:
    branches: [ "main" ]
    # Limit to function projects (matches your folders)
    paths:
      - 'Functions/OrivoDent.Backend.Functions.GenerateAITreatmentPlan/**'
      - 'Functions/OpenDentalIntegrationFunctionApp/**'
      - 'Functions/TranscribeSessionAudio/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  DOTNET_VERSION: '8.0.x'
  # Replace these with your actual Function App names (no slots)
  AZURE_FUNCTION_GENERATE_AI_TREATMENT_PLAN_DEV: "YOUR-GENERATE-AI-TREATMENT-PLAN-APP-NAME"
  AZURE_FUNCTION_OPEN_DENTAL_INTEGRATION_DEV: "YOUR-OPEN-DENTAL-INTEGRATION-APP-NAME"
  AZURE_FUNCTION_AI_PROCESSING_DEV: "YOUR-AI-PROCESSING-FUNCTION-APP-NAME"

jobs:
  build-deploy-functions:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ================= PUBLISH FUNCTIONS =================
      # Priority: AiProcessing must succeed

      - name: Publish Function - AiProcessing (Priority)
        id: publish-ai-processing
        run: dotnet publish Functions/TranscribeSessionAudio/AiProcessingFunctionApp.csproj -c Release -o ./publish-functions/AiProcessing

      # Secondary functions (non-blocking if they fail to build)

      - name: Publish Function - GenerateAITreatmentPlan
        id: publish-generate-ai
        continue-on-error: true
        run: dotnet publish Functions/OrivoDent.Backend.Functions.GenerateAITreatmentPlan/OrivoDent.Backend.Functions.GenerateAITreatmentPlan.csproj -c Release -o ./publish-functions/GenerateAITreatmentPlan

      - name: Publish Function - OpenDentalIntegration
        id: publish-open-dental
        continue-on-error: true
        run: dotnet publish Functions/OpenDentalIntegrationFunctionApp/OpenDentalIntegrationFunctionApp.csproj -c Release -o ./publish-functions/OpenDentalIntegration

      # ================= DEBUG PUBLISH PROFILES (OPTIONAL) =================

      - name: Debug publish profile - GenerateAITreatmentPlan
        shell: pwsh
        run: |
          $xml = @'
          ${{ secrets.AZURE_FUNCTION_GENERATE_AI_TREATMENT_PLAN_DEV }}
          '@
          [xml]$pub = $xml
          $pub.publishData.publishProfile |
            Select-Object publishMethod, msdeploySite, userName |
            Format-List

      - name: Debug publish profile - OpenDentalIntegration
        shell: pwsh
        run: |
          $xml = @'
          ${{ secrets.AZURE_FUNCTION_OPEN_DENTAL_INTEGRATION_DEV }}
          '@
          [xml]$pub = $xml
          $pub.publishData.publishProfile |
            Select-Object publishMethod, msdeploySite, userName |
            Format-List

      - name: Debug publish profile - AiProcessing (dev app)
        shell: pwsh
        run: |
          $xml = @'
          ${{ secrets.AZURE_FUNCTION_AI_PROCESSING_DEV }}
          '@
          [xml]$pub = $xml
          $pub.publishData.publishProfile |
            Select-Object publishMethod, msdeploySite, userName |
            Format-List

       # ===== Validate Function App Environment Variables =====
      - name: Debug and validate function app env vars
        shell: pwsh
        run: |
          $aiPlan          = $env:AZURE_FUNCTION_GENERATE_AI_TREATMENT_PLAN_DEV
          $openDental      = $env:AZURE_FUNCTION_OPEN_DENTAL_INTEGRATION_DEV
          $aiProcessingDev = $env:AZURE_FUNCTION_AI_PROCESSING_DEV

          Write-Host "AZURE_FUNCTION_GENERATE_AI_TREATMENT_PLAN_DEV = '$aiPlan'"
          Write-Host "AZURE_FUNCTION_OPEN_DENTAL_INTEGRATION_DEV   = '$openDental'"
          Write-Host "AZURE_FUNCTION_AI_PROCESSING_DEV            = '$aiProcessingDev'"

          $hasError = $false
          if (-not $aiPlan) {
            Write-Host "ERROR: AZURE_FUNCTION_GENERATE_AI_TREATMENT_PLAN_DEV is empty or not set in env."
            $hasError = $true
          }
          if (-not $openDental) {
            Write-Host "ERROR: AZURE_FUNCTION_OPEN_DENTAL_INTEGRATION_DEV is empty or not set in env."
            $hasError = $true
          }
          if (-not $aiProcessingDev) {
            Write-Host "ERROR: AZURE_FUNCTION_AI_PROCESSING_DEV is empty or not set in env."
            $hasError = $true
          }

          if ($hasError) {
            throw "One or more function app environment variables are missing. Update the env: block at the top of the workflow."
          }

      # ================= BUILD SUMMARY =================

      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "======================================"
          Write-Host "   BUILD SUMMARY"
          Write-Host "======================================"
          Write-Host ""
          
          $aiProcessing = "${{ steps.publish-ai-processing.outcome }}"
          $generateAI = "${{ steps.publish-generate-ai.outcome }}"
          $openDental = "${{ steps.publish-open-dental.outcome }}"
          
          Write-Host "🔹 AiProcessing Build:           $aiProcessing" -ForegroundColor $(if($aiProcessing -eq 'success'){'Green'}else{'Red'})
          Write-Host "🔹 GenerateAITreatmentPlan Build: $generateAI" -ForegroundColor $(if($generateAI -eq 'success'){'Green'}else{'Yellow'})
          Write-Host "🔹 OpenDentalIntegration Build:   $openDental" -ForegroundColor $(if($openDental -eq 'success'){'Green'}else{'Yellow'})
          Write-Host ""
          
          if ($aiProcessing -ne 'success') {
            Write-Host "❌ CRITICAL: AiProcessing build failed - deployment will be skipped!" -ForegroundColor Red
            exit 1
          }

      # ================= DEPLOY FUNCTIONS =================
      # Deploy AiProcessing FIRST (critical priority)

      - name: Deploy Function - AiProcessing (Priority)
        id: deploy-ai-processing
        if: steps.publish-ai-processing.outcome == 'success'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTION_AI_PROCESSING_DEV }}
          package: ./publish-functions/AiProcessing
          publish-profile: ${{ secrets.AZURE_FUNCTION_AI_PROCESSING_DEV }}
          respect-funcignore: true

      - name: Verify AiProcessing Deployment
        if: steps.deploy-ai-processing.outcome == 'success'
        run: echo "✅ AiProcessing function deployed successfully"

      # Deploy remaining functions (only if build succeeded, non-blocking failures)

      - name: Deploy Function - GenerateAITreatmentPlan
        id: deploy-generate-ai
        if: steps.publish-generate-ai.outcome == 'success'
        uses: Azure/functions-action@v1
        continue-on-error: true
        with:
          app-name: ${{ env.AZURE_FUNCTION_GENERATE_AI_TREATMENT_PLAN_DEV }}
          package: ./publish-functions/GenerateAITreatmentPlan
          publish-profile: ${{ secrets.AZURE_FUNCTION_GENERATE_AI_TREATMENT_PLAN_DEV }}
          respect-funcignore: true

      - name: Deploy Function - OpenDentalIntegration
        id: deploy-open-dental
        if: steps.publish-open-dental.outcome == 'success'
        uses: Azure/functions-action@v1
        continue-on-error: true
        with:
          app-name: ${{ env.AZURE_FUNCTION_OPEN_DENTAL_INTEGRATION_DEV }}
          package: ./publish-functions/OpenDentalIntegration
          publish-profile: ${{ secrets.AZURE_FUNCTION_OPEN_DENTAL_INTEGRATION_DEV }}
          respect-funcignore: true

      # ================= DEPLOYMENT SUMMARY =================

      - name: Deployment Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "======================================"
          Write-Host "   AZURE FUNCTIONS DEPLOYMENT SUMMARY"
          Write-Host "======================================"
          Write-Host ""
          
          # Build outcomes
          $buildAiProcessing = "${{ steps.publish-ai-processing.outcome }}"
          $buildGenerateAI = "${{ steps.publish-generate-ai.outcome }}"
          $buildOpenDental = "${{ steps.publish-open-dental.outcome }}"
          
          # Deploy outcomes
          $deployAiProcessing = "${{ steps.deploy-ai-processing.outcome }}"
          $deployGenerateAI = "${{ steps.deploy-generate-ai.outcome }}"
          $deployOpenDental = "${{ steps.deploy-open-dental.outcome }}"
          
          Write-Host "📦 BUILD STATUS:" -ForegroundColor Cyan
          Write-Host "   AiProcessing:           $buildAiProcessing" -ForegroundColor $(if($buildAiProcessing -eq 'success'){'Green'}else{'Red'})
          Write-Host "   GenerateAITreatmentPlan: $buildGenerateAI" -ForegroundColor $(if($buildGenerateAI -eq 'success'){'Green'}else{'Yellow'})
          Write-Host "   OpenDentalIntegration:   $buildOpenDental" -ForegroundColor $(if($buildOpenDental -eq 'success'){'Green'}else{'Yellow'})
          Write-Host ""
          
          Write-Host "🚀 DEPLOYMENT STATUS:" -ForegroundColor Cyan
          Write-Host "   AiProcessing:           $deployAiProcessing" -ForegroundColor $(if($deployAiProcessing -eq 'success'){'Green'}elseif($deployAiProcessing -eq 'skipped'){'Yellow'}else{'Red'})
          Write-Host "   GenerateAITreatmentPlan: $deployGenerateAI" -ForegroundColor $(if($deployGenerateAI -eq 'success'){'Green'}elseif($deployGenerateAI -eq 'skipped'){'Yellow'}else{'Yellow'})
          Write-Host "   OpenDentalIntegration:   $deployOpenDental" -ForegroundColor $(if($deployOpenDental -eq 'success'){'Green'}elseif($deployOpenDental -eq 'skipped'){'Yellow'}else{'Yellow'})
          Write-Host ""
          
          # Check critical deployment
          if ($deployAiProcessing -ne 'success') {
            Write-Host "❌ CRITICAL: AiProcessing deployment did not complete successfully!" -ForegroundColor Red
            Write-Host "   Build status: $buildAiProcessing" -ForegroundColor $(if($buildAiProcessing -eq 'success'){'Green'}else{'Red'})
            exit 1
          } else {
            Write-Host "✅ Priority deployment (AiProcessing) completed successfully" -ForegroundColor Green
            
            # Check secondary deployments
            $warnings = @()
            if ($buildGenerateAI -ne 'success') { $warnings += "GenerateAITreatmentPlan build failed" }
            if ($buildOpenDental -ne 'success') { $warnings += "OpenDentalIntegration build failed" }
            if ($deployGenerateAI -eq 'skipped') { $warnings += "GenerateAITreatmentPlan deployment skipped (build failed)" }
            if ($deployOpenDental -eq 'skipped') { $warnings += "OpenDentalIntegration deployment skipped (build failed)" }
            if ($deployGenerateAI -eq 'failure') { $warnings += "GenerateAITreatmentPlan deployment failed" }
            if ($deployOpenDental -eq 'failure') { $warnings += "OpenDentalIntegration deployment failed" }
            
            if ($warnings.Count -gt 0) {
              Write-Host "⚠️  WARNINGS:" -ForegroundColor Yellow
              foreach ($warning in $warnings) {
                Write-Host "   - $warning" -ForegroundColor Yellow
              }
              Write-Host "   Workflow continues as AiProcessing is operational" -ForegroundColor Yellow
            } else {
              Write-Host "✅ All functions deployed successfully!" -ForegroundColor Green
            }
          }
