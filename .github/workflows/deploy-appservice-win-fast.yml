name: Deploy WEB API to DEV (Skip Tests)

on:
  workflow_dispatch:
    inputs:
      skip_migration:
        description: 'Skip database migration'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-deploy-migrate:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Derive API App Service name from publish profile
      - name: Derive app name from publish profile
        shell: pwsh
        run: |
          $pubXml = @'
          ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          '@
          [xml]$pub = $pubXml
          $pp = $pub.publishData.publishProfile | Where-Object { $_.publishMethod -eq 'MSDeploy' } | Select-Object -First 1
          if (-not $pp) { throw "MSDeploy profile not found in AZURE_WEBAPP_PUBLISH_PROFILE" }
          $app = $pp.msdeploySite
          if (-not $app) { throw "msdeploySite not present in publish profile" }
          "AZURE_WEBAPP_NAME=$app" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Debug resolved API app name
        shell: pwsh
        run: |
          Write-Host "AZURE_WEBAPP_NAME from GITHUB_ENV: '$env:AZURE_WEBAPP_NAME'"

      - name: Restore API
        run: dotnet restore OrivoDent.Backend.Api/OrivoDent.Backend.Api.csproj

      - name: Build API (Release)
        run: dotnet build OrivoDent.Backend.Api/OrivoDent.Backend.Api.csproj --configuration Release --no-restore

      - name: Publish API (win-x64, self-contained)
        run: dotnet publish OrivoDent.Backend.Api/OrivoDent.Backend.Api.csproj -c Release -r win-x64 --self-contained true -o ./publish

      # EF MIGRATION BUNDLE (conditional)
      - name: Install dotnet-ef
        if: ${{ !inputs.skip_migration }}
        run: |
          dotnet tool install --global dotnet-ef --version 8.*
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create EF migrations bundle (win-x64) into publish folder
        if: ${{ !inputs.skip_migration }}
        run: >
          dotnet ef migrations bundle
          --project OrivoDent.Backend.Infrastructure/OrivoDent.Backend.Infrastructure.csproj
          --startup-project OrivoDent.Backend.Api/OrivoDent.Backend.Api.csproj
          --output ./publish/migrate.exe
          --self-contained
          --target-runtime win-x64

      # DEPLOY API
      - name: Deploy API to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./publish

      # RUN EF MIGRATIONS VIA KUDU (conditional)
      - name: Run EF migrations via Kudu API (using publish profile)
        if: ${{ !inputs.skip_migration }}
        shell: pwsh
        run: |
          $pubXml = @'
          ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          '@
          [xml]$pub = $pubXml
          $pp = $pub.publishData.publishProfile | Where-Object { $_.publishMethod -eq 'MSDeploy' } | Select-Object -First 1
          if (-not $pp) { throw "MSDeploy profile not found" }
          $user = ("" + $pp.userName).Trim()
          $pwd  = ("" + $pp.userPWD).Trim()
          $site = $env:AZURE_WEBAPP_NAME
          if (-not $site) { $site = $pp.msdeploySite }
          if (-not $site) { throw "Site name not resolved" }
          $kuduBase = "https://$site.scm.azurewebsites.net"

          $pair   = "{0}:{1}" -f $user, $pwd
          $bytes  = [System.Text.Encoding]::ASCII.GetBytes($pair)
          $token  = [System.Convert]::ToBase64String($bytes)
          $headers = @{ Authorization = "Basic $token" }

          try {
            $e = Invoke-RestMethod -Uri "$kuduBase/api/environment" -Headers $headers -Method Get -TimeoutSec 60 -ErrorAction Stop
            Write-Host "Kudu auth OK. Site: $($e.systemSiteName)"
          } catch {
            Write-Host "Kudu auth failed (likely wrong credentials)."
            throw
          }

          $cmd = 'cmd /c D:\home\site\wwwroot\migrate.exe --connection ^"%SQL_CONNECTION_STRING%^" --verbose'
          $body = @{ command = $cmd; dir = 'site\wwwroot' } | ConvertTo-Json

          $resp = Invoke-RestMethod -Uri "$kuduBase/api/command" -Headers $headers -Method Post -ContentType 'application/json' -Body $body -TimeoutSec 1800 -ErrorAction Stop

          if ($resp.ExitCode -ne 0) {
            throw "Migrations failed with exit code $($resp.ExitCode)."
          }

      - name: Deployment Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "======================================"
          Write-Host "   FAST DEPLOYMENT SUMMARY"
          Write-Host "======================================"
          Write-Host ""
          Write-Host "✅ API deployed to: $env:AZURE_WEBAPP_NAME" -ForegroundColor Green
          
          $skipMigration = '${{ inputs.skip_migration }}'
          if ($skipMigration -eq 'true') {
            Write-Host "⚠️  Database migration was skipped (manual request)" -ForegroundColor Yellow
          } else {
            Write-Host "✅ Database migration completed" -ForegroundColor Green
          }
          
          Write-Host ""
          Write-Host "⚡ Fast deployment completed (integration tests skipped)" -ForegroundColor Cyan
