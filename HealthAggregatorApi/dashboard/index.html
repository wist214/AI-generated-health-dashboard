<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Aggregator</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="stylesheet" href="css/styles.css">
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>.skip-link{position:absolute;top:-40px;left:0;background:#00d4ff;color:#fff;padding:8px 16px;z-index:1001;text-decoration:none;border-radius:0 0 8px 0;transition:top .2s}.skip-link:focus{top:0}</style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <header>
            <div class="header-content" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="width: 50px;"></div>
                <div class="header-text" style="flex: 1; text-align: center;">
                    <h1>Health Aggregator</h1>
                    <p>Track your health data from multiple sources</p>
                </div>
                <button type="button" class="settings-btn" onclick="openSettingsModal()" aria-label="Open Settings" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px 14px; font-size: 1.5rem; cursor: pointer; width: 50px;">
                    ⚙️
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-nav" role="tablist" aria-label="Health data sections">
            <button type="button" class="tab-btn dashboard-btn active" role="tab" aria-selected="true" aria-controls="dashboard-tab" data-tab="dashboard">
                <span class="tab-icon">📊</span>
                <span class="tab-text">Dashboard</span>
            </button>
            <button type="button" class="tab-btn" role="tab" aria-selected="false" aria-controls="picooc-tab" data-tab="picooc">
                <span class="tab-icon">⚖️</span>
                <span class="tab-text">Weight</span>
            </button>
            <button type="button" class="tab-btn oura-btn" role="tab" aria-selected="false" aria-controls="oura-tab" data-tab="oura">
                <span class="tab-icon">💍</span>
                <span class="tab-text">Oura Ring</span>
            </button>
            <button type="button" class="tab-btn food-btn" role="tab" aria-selected="false" aria-controls="food-tab" data-tab="food">
                <span class="tab-icon">🍎</span>
                <span class="tab-text">Food</span>
            </button>
        </div>

        <!-- Dashboard Tab Content -->
        <div id="dashboard-tab" class="tab-content active" role="tabpanel" aria-labelledby="dashboard-tab">
            <div class="dashboard-header">
                <h2>🎯 Your Health Dashboard</h2>
                <p class="date" id="dashboardDate">Loading...</p>
            </div>

            <div class="dashboard-grid">
                <!-- Weight Card -->
                <div class="metric-card weight">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span class="icon">⚖️</span>
                            <h3>Weight</h3>
                        </div>
                        <span class="metric-source">Picooc</span>
                    </div>
                    <div class="metric-value" id="dashWeight">--<span class="metric-unit"> kg</span></div>
                    <div class="metric-date" id="dashWeightDate">No data</div>
                    <div class="progress-section">
                        <h4>Progress</h4>
                        <div class="progress-grid">
                            <div class="progress-item">
                                <div class="label">vs Previous</div>
                                <div class="change neutral" id="weightVsYesterday">--</div>
                                <div class="abs-value" id="weightYesterdayAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs ~1 Week</div>
                                <div class="change neutral" id="weightVsWeek">--</div>
                                <div class="abs-value" id="weightWeekAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs ~1 Month</div>
                                <div class="change neutral" id="weightVsMonth">--</div>
                                <div class="abs-value" id="weightMonthAbs"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Body Score Card -->
                <div class="metric-card body-score">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span class="icon">💪</span>
                            <h3>Body Fat</h3>
                        </div>
                        <span class="metric-source">Picooc</span>
                    </div>
                    <div class="metric-value" id="dashBodyFat">--<span class="metric-unit">%</span></div>
                    <div class="metric-date" id="dashBodyFatDate">No data</div>
                    <div class="progress-section">
                        <h4>Progress</h4>
                        <div class="progress-grid">
                            <div class="progress-item">
                                <div class="label">vs Previous</div>
                                <div class="change neutral" id="bodyFatVsYesterday">--</div>
                                <div class="abs-value" id="bodyFatYesterdayAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs ~1 Week</div>
                                <div class="change neutral" id="bodyFatVsWeek">--</div>
                                <div class="abs-value" id="bodyFatWeekAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs ~1 Month</div>
                                <div class="change neutral" id="bodyFatVsMonth">--</div>
                                <div class="abs-value" id="bodyFatMonthAbs"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sleep Score Card -->
                <div class="metric-card sleep">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span class="icon">😴</span>
                            <h3>Sleep Score</h3>
                        </div>
                        <span class="metric-source">Oura Ring</span>
                    </div>
                    <div class="metric-value" id="dashSleepScore">--</div>
                    <div class="metric-date" id="dashSleepDate">No data</div>
                    <div class="progress-section">
                        <h4>Progress</h4>
                        <div class="progress-grid">
                            <div class="progress-item">
                                <div class="label">vs Yesterday</div>
                                <div class="change neutral" id="sleepVsYesterday">--</div>
                                <div class="abs-value" id="sleepYesterdayAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs 1 Week</div>
                                <div class="change neutral" id="sleepVsWeek">--</div>
                                <div class="abs-value" id="sleepWeekAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs 1 Month</div>
                                <div class="change neutral" id="sleepVsMonth">--</div>
                                <div class="abs-value" id="sleepMonthAbs"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Readiness Score Card -->
                <div class="metric-card readiness">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span class="icon">⚡</span>
                            <h3>Readiness</h3>
                        </div>
                        <span class="metric-source">Oura Ring</span>
                    </div>
                    <div class="metric-value" id="dashReadiness">--</div>
                    <div class="metric-date" id="dashReadinessDate">No data</div>
                    <div class="progress-section">
                        <h4>Progress</h4>
                        <div class="progress-grid">
                            <div class="progress-item">
                                <div class="label">vs Yesterday</div>
                                <div class="change neutral" id="readinessVsYesterday">--</div>
                                <div class="abs-value" id="readinessYesterdayAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs 1 Week</div>
                                <div class="change neutral" id="readinessVsWeek">--</div>
                                <div class="abs-value" id="readinessWeekAbs"></div>
                            </div>
                            <div class="progress-item">
                                <div class="label">vs 1 Month</div>
                                <div class="change neutral" id="readinessVsMonth">--</div>
                                <div class="abs-value" id="readinessMonthAbs"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats Row -->
            <div class="quick-stats">
                <div class="quick-stat">
                    <div class="icon">🏃</div>
                    <div class="info">
                        <h4>Steps Today</h4>
                        <div class="value" id="dashSteps">--</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <div class="icon">🛏️</div>
                    <div class="info">
                        <h4>Sleep Duration</h4>
                        <div class="value" id="dashSleepDuration">--</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <div class="icon">❤️</div>
                    <div class="info">
                        <h4>Avg Heart Rate</h4>
                        <div class="value" id="dashAvgHR">--</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <div class="icon">🔥</div>
                    <div class="info">
                        <h4>Calories</h4>
                        <div class="value" id="dashKcalQuick">-- / --</div>
                    </div>
                </div>
            </div>

            <!-- Goals Section -->
            <div class="dashboard-section">
                <h3>📈 Weekly Trends</h3>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="dashboardChart"></canvas>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="dashboard-section" id="tipsSection">
                <h3>💡 Insights</h3>
                <div id="insightsList" class="no-data-message">
                    Sync your data to get personalized insights
                </div>
            </div>
        </div>

        <!-- Picooc Tab Content -->
        <div id="picooc-tab" class="tab-content" role="tabpanel" aria-labelledby="picooc-tab">
            <div class="controls">
                <button type="button" class="btn btn-primary" id="syncBtn">
                    🔄 Sync Data
                </button>
                <div id="statusMessage" class="status"></div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h3>Weight</h3>
                    <div class="value" id="currentWeight">--</div>
                    <div class="details" id="weightDetails">No data</div>
                </div>
                <div class="stat-card">
                    <h3>Body Fat</h3>
                    <div class="value" id="currentBodyFat">--</div>
                    <div class="details" id="bodyFatDetails">No data</div>
                </div>
                <div class="stat-card">
                    <h3>BMI</h3>
                    <div class="value" id="currentBMI">--</div>
                    <div class="details" id="bmiDetails">No data</div>
                </div>
                <div class="stat-card">
                    <h3>Muscle Mass</h3>
                    <div class="value" id="currentMuscle">--</div>
                    <div class="details" id="muscleDetails">No data</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h2>📊 Weight Trends</h2>
                    <div class="chart-toggles" data-chart="picooc">
                        <label class="toggle-label">
                            <input type="checkbox" id="showWeight" checked>
                            <span style="color: #00d4ff">● Weight</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showBodyFat" checked>
                            <span style="color: #f472b6">● Body Fat</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showBMI">
                            <span style="color: #a78bfa">● BMI</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showMuscle">
                            <span style="color: #34d399">● Muscle</span>
                        </label>
                    </div>
                </div>
                <div class="time-range-selector" id="picooc-time-selector">
                    <button type="button" class="time-btn" data-range="7d">7 Days</button>
                    <button type="button" class="time-btn" data-range="30d">30 Days</button>
                    <button type="button" class="time-btn" data-range="90d">3 Months</button>
                    <button type="button" class="time-btn" data-range="6m">6 Months</button>
                    <button type="button" class="time-btn" data-range="1y">1 Year</button>
                    <button type="button" class="time-btn active" data-range="all">All Time</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="picoocChart"></canvas>
                </div>
            </div>

            <div class="data-table">
                <h2>📋 Measurement History</h2>
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Weight (kg)</th>
                            <th scope="col">Body Fat (%)</th>
                            <th scope="col">BMI</th>
                            <th scope="col">Muscle (kg)</th>
                            <th scope="col">Water (%)</th>
                            <th scope="col">Metabolic Age</th>
                        </tr>
                    </thead>
                    <tbody id="picoocTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <h3>No data yet</h3>
                                <p>Click "Sync Data" to fetch your measurements</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination" id="picoocPagination">
                    <button type="button" class="page-btn" id="picoocPrevBtn" disabled>← Previous</button>
                    <span class="page-info" id="picoocPageInfo">Page 1 of 1</span>
                    <button type="button" class="page-btn" id="picoocNextBtn" disabled>Next →</button>
                </div>
            </div>
        </div>

        <!-- Oura Tab Content -->
        <div id="oura-tab" class="tab-content" role="tabpanel" aria-labelledby="oura-tab">
            <div class="controls">
                <button type="button" class="btn btn-oura" id="ouraSyncBtn">
                    🔄 Sync Oura Data
                </button>
                <div id="ouraStatusMessage" class="status"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card oura">
                    <h3>Sleep Score</h3>
                    <div class="value" id="ouraSleepScore">--</div>
                    <div class="details" id="ouraSleepDetails">No data</div>
                </div>
                <div class="stat-card oura">
                    <h3>Readiness Score</h3>
                    <div class="value" id="ouraReadinessScore">--</div>
                    <div class="details" id="ouraReadinessDetails">No data</div>
                </div>
                <div class="stat-card oura">
                    <h3>Activity Score</h3>
                    <div class="value" id="ouraActivityScore">--</div>
                    <div class="details" id="ouraActivityDetails">No data</div>
                </div>
                <div class="stat-card oura">
                    <h3>Avg Sleep Duration</h3>
                    <div class="value" id="ouraAvgSleep">--</div>
                    <div class="details" id="ouraAvgSleepDetails">No data</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h2>📊 Health Scores</h2>
                    <div class="chart-toggles" data-chart="oura">
                        <label class="toggle-label">
                            <input type="checkbox" id="showSleepScore" checked>
                            <span style="color: #3b82f6">● Sleep</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showReadinessScore" checked>
                            <span style="color: #22c55e">● Readiness</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showActivityScore" checked>
                            <span style="color: #f59e0b">● Activity</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showSteps">
                            <span style="color: #8b5cf6">● Steps</span>
                        </label>
                    </div>
                </div>
                <div class="time-range-selector" id="oura-time-selector">
                    <button type="button" class="time-btn oura" data-range="7d">7 Days</button>
                    <button type="button" class="time-btn oura" data-range="30d">30 Days</button>
                    <button type="button" class="time-btn oura" data-range="90d">3 Months</button>
                    <button type="button" class="time-btn oura" data-range="6m">6 Months</button>
                    <button type="button" class="time-btn oura active" data-range="1y">1 Year</button>
                    <button type="button" class="time-btn oura" data-range="all">All Time</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="ouraChart"></canvas>
                </div>
            </div>

            <!-- Sleep Details Section -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>😴 Sleep Duration</h2>
                    <div class="chart-toggles" data-chart="sleep">
                        <label class="toggle-label">
                            <input type="checkbox" id="showTotalSleep" checked>
                            <span style="color: #3b82f6">● Total Sleep</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showDeepSleep" checked>
                            <span style="color: #1e40af">● Deep Sleep</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showRemSleep" checked>
                            <span style="color: #8b5cf6">● REM Sleep</span>
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="showAvgHR">
                            <span style="color: #ef4444">● Avg HR</span>
                        </label>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="sleepChart"></canvas>
                </div>
            </div>

            <div class="data-table oura-table">
                <h2>😴 Sleep History</h2>
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Score</th>
                            <th scope="col">Total Sleep</th>
                            <th scope="col">Deep Sleep</th>
                            <th scope="col">REM Sleep</th>
                            <th scope="col">Avg HR</th>
                            <th scope="col">HRV</th>
                            <th scope="col">Efficiency</th>
                        </tr>
                    </thead>
                    <tbody id="ouraSleepTableBody">
                        <tr>
                            <td colspan="8" class="empty-state">
                                <h3>No data yet</h3>
                                <p>Click "Sync Oura Data" to fetch your sleep data</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="data-table oura-table" style="margin-top: 30px;">
                <h2>🏃 Activity History</h2>
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Score</th>
                            <th scope="col">Steps</th>
                            <th scope="col">Active Cal</th>
                            <th scope="col">Total Cal</th>
                            <th scope="col">Distance</th>
                            <th scope="col">High Activity</th>
                            <th scope="col">Med Activity</th>
                        </tr>
                    </thead>
                    <tbody id="ouraActivityTableBody">
                        <tr>
                            <td colspan="8" class="empty-state">
                                <h3>No data yet</h3>
                                <p>Click "Sync Oura Data" to fetch your activity data</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Food Tab -->
        <div id="food-tab" class="tab-content" role="tabpanel" aria-labelledby="food-tab-btn">
        <div class="controls">
            <button type="button" class="btn btn-food" id="syncFoodBtn">
                🔄 Sync Cronometer
            </button>
            <div id="foodStatusMessage" class="status"></div>
        </div>

        <!-- Today's Summary Cards -->
        <div class="stats-grid">
            <div class="stat-card food">
                <h3>Calories</h3>
                <div class="value" id="food-calories">--</div>
                <div class="details" id="food-calories-details">No data</div>
            </div>
            <div class="stat-card food">
                <h3>Protein</h3>
                <div class="value" id="food-protein">--</div>
                <div class="details" id="food-protein-details">No data</div>
            </div>
            <div class="stat-card food">
                <h3>Carbs</h3>
                <div class="value" id="food-carbs">--</div>
                <div class="details" id="food-carbs-details">No data</div>
            </div>
            <div class="stat-card food">
                <h3>Fat</h3>
                <div class="value" id="food-fat">--</div>
                <div class="details" id="food-fat-details">No data</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="chart-container">
            <div class="chart-header">
                <h2>📊 Calorie Trend (7 Days)</h2>
            </div>
            <div class="chart-wrapper">
                <canvas id="calorieTrendChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <h2>🥧 Macro Breakdown</h2>
            </div>
            <div class="macro-chart-row">
                <div class="macro-chart-wrapper">
                    <canvas id="macroChart"></canvas>
                </div>
                <div class="macro-legend" id="macroLegend"></div>
            </div>
        </div>

        <!-- Nutrient Progress Bars -->
        <div class="chart-container">
            <div class="chart-header">
                <h2>🧪 Key Nutrients</h2>
            </div>
            <div class="nutrients-grid" id="nutrientsGrid">
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Fiber</span>
                        <span class="nutrient-value" id="nutrient-fiber">-- / -- g</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill fiber" id="fiber-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Sugar</span>
                        <span class="nutrient-value" id="nutrient-sugar">-- / -- g</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill sugar" id="sugar-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Sodium</span>
                        <span class="nutrient-value" id="nutrient-sodium">-- / -- mg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill sodium" id="sodium-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Cholesterol</span>
                        <span class="nutrient-value" id="nutrient-cholesterol">-- / -- mg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill cholesterol" id="cholesterol-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Vitamin D</span>
                        <span class="nutrient-value" id="nutrient-vitaminD">-- / -- µg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill vitamin" id="vitaminD-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Calcium</span>
                        <span class="nutrient-value" id="nutrient-calcium">-- / -- mg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill mineral" id="calcium-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Iron</span>
                        <span class="nutrient-value" id="nutrient-iron">-- / -- mg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill mineral" id="iron-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nutrient-bar">
                    <div class="nutrient-header">
                        <span class="nutrient-name">Potassium</span>
                        <span class="nutrient-value" id="nutrient-potassium">-- / -- mg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill mineral" id="potassium-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Food Log Table -->
        <div class="chart-container">
            <div class="chart-header">
                <h2>🍽️ Today's Food Log</h2>
                <div class="date-selector">
                    <button type="button" class="time-btn food" id="foodPrevDay">◀</button>
                    <span id="foodSelectedDate">Today</span>
                    <button type="button" class="time-btn food" id="foodNextDay">▶</button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Food</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Calories</th>
                            <th>Protein</th>
                            <th>Carbs</th>
                            <th>Fat</th>
                        </tr>
                    </thead>
                    <tbody id="foodLogBody">
                        <tr class="empty-state">
                            <td colspan="7">
                                <div class="empty-icon">🍽️</div>
                                <p>Click "Sync Cronometer" to fetch your food data</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div> <!-- end container -->

    <!-- Sleep Detail Modal -->
    <div class="modal-overlay" id="sleepModal">
        <div class="modal sleep-modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);">
                <h2>Sleep Analysis</h2>
                <div class="modal-date" id="modalDate">--</div>
                <button type="button" class="modal-close" aria-label="Close sleep analysis modal">×</button>
            </div>
            <div class="modal-body">
                <!-- Hero Metrics -->
                <div class="metric-hero sleep-hero">
                    <div class="hero-metric">
                        <div class="hero-icon emoji-icon">🌙</div>
                        <div class="hero-value" id="modalScore">--</div>
                        <div class="hero-label">Sleep Score</div>
                    </div>
                    <div class="hero-metric">
                        <div class="hero-icon emoji-icon">⏱️</div>
                        <div class="hero-value" id="modalTotalSleep">--</div>
                        <div class="hero-label">Total Sleep</div>
                    </div>
                    <div class="hero-metric">
                        <div class="hero-icon emoji-icon">✨</div>
                        <div class="hero-value" id="modalRestfulness">--</div>
                        <div class="hero-label">Restfulness</div>
                    </div>
                </div>

                <!-- Sleep Timing -->
                <div class="sleep-timing-section">
                    <div class="timing-row">
                        <div class="timing-item">
                            <span class="timing-label">Bedtime</span>
                            <span class="timing-value" id="modalBedtime">--</span>
                        </div>
                        <div class="timing-arrow">→</div>
                        <div class="timing-item">
                            <span class="timing-label">Wake Time</span>
                            <span class="timing-value" id="modalWakeTime">--</span>
                        </div>
                        <div class="timing-item efficiency">
                            <span class="timing-label">Efficiency</span>
                            <span class="timing-value" id="modalEfficiency">--</span>
                        </div>
                    </div>
                </div>

                <!-- Sleep Stages -->
                <div class="sleep-stages">
                    <h3>Sleep Stages</h3>
                    <div class="stage-bar" id="stageBar"></div>
                    <div class="stage-legend">
                        <div class="stage-legend-item"><span class="dot stage-deep"></span> Deep: <span id="modalDeep">--</span></div>
                        <div class="stage-legend-item"><span class="dot stage-light"></span> Light: <span id="modalLight">--</span></div>
                        <div class="stage-legend-item"><span class="dot stage-rem"></span> REM: <span id="modalRem">--</span></div>
                        <div class="stage-legend-item"><span class="dot stage-awake"></span> Awake: <span id="modalAwake">--</span></div>
                    </div>
                </div>

                <!-- Vitals Grid -->
                <div class="vitals-section">
                    <h3>Sleep Vitals</h3>
                    <div class="vitals-grid">
                        <div class="vital-card">
                            <div class="vital-icon emoji-icon">❤️</div>
                            <div class="vital-value" id="modalAvgHR">--</div>
                            <div class="vital-label">Avg Heart Rate</div>
                            <div class="vital-sub" id="modalLowestHR">Lowest: --</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-icon emoji-icon">💓</div>
                            <div class="vital-value" id="modalHRV">--</div>
                            <div class="vital-label">HRV (RMSSD)</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-icon emoji-icon">🌬️</div>
                            <div class="vital-value" id="modalBreath">--</div>
                            <div class="vital-label">Breathing Rate</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-icon emoji-icon">⏳</div>
                            <div class="vital-value" id="modalLatency">--</div>
                            <div class="vital-label">Sleep Latency</div>
                        </div>
                    </div>
                </div>

                <!-- Time in Bed info -->
                <div class="time-in-bed-info">
                    <span id="modalTimeInBed">Time in bed: --</span>
                    <span id="modalRestless">Restless periods: --</span>
                </div>

                <div class="contributors-section" id="contributorsSection" style="display: none;">
                    <h3>Score Contributors</h3>
                    <div class="contributor-list" id="contributorsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Measurement Detail Modal -->
    <div class="modal-overlay" id="measurementModal">
        <div class="modal measurement-modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);">
                <h2>Body Composition</h2>
                <div class="modal-date" id="measurementModalDate">--</div>
                <button type="button" class="modal-close" aria-label="Close body composition modal">×</button>
            </div>
            <div class="modal-body">
                <!-- Primary Metrics -->
                <div class="metric-hero">
                    <div class="hero-metric">
                        <div class="hero-icon emoji-icon">⚖️</div>
                        <div class="hero-value" id="measurementWeight">--</div>
                        <div class="hero-label">Weight (kg)</div>
                    </div>
                    <div class="hero-metric">
                        <div class="hero-icon emoji-icon">🔥</div>
                        <div class="hero-value" id="measurementBodyFatHero">--</div>
                        <div class="hero-label">Body Fat</div>
                        <div class="hero-status" id="bodyFatStatus">%</div>
                    </div>
                    <div class="hero-metric">
                        <div class="hero-icon emoji-icon">📊</div>
                        <div class="hero-value" id="measurementBMI">--</div>
                        <div class="hero-label">BMI</div>
                        <div class="hero-status" id="measurementBMIStatus">--</div>
                    </div>
                </div>

                <!-- Body Composition Section -->
                <div class="composition-section">
                    <h3>Body Composition</h3>
                    <div class="composition-bars">
                        <div class="comp-item">
                            <div class="comp-header">
                                <span class="comp-label">💪 Muscle Mass</span>
                                <span class="comp-value" id="measurementMuscle">--</span>
                                <span class="comp-unit">kg</span>
                            </div>
                            <div class="comp-bar"><div class="comp-fill muscle" id="muscleBar"></div></div>
                        </div>
                        <div class="comp-item">
                            <div class="comp-header">
                                <span class="comp-label">🔥 Body Fat</span>
                                <span class="comp-value" id="measurementBodyFat">--</span>
                                <span class="comp-unit">%</span>
                            </div>
                            <div class="comp-bar"><div class="comp-fill fat" id="fatBar"></div></div>
                        </div>
                        <div class="comp-item">
                            <div class="comp-header">
                                <span class="comp-label">💧 Body Water</span>
                                <span class="comp-value" id="measurementWater">--</span>
                                <span class="comp-unit">%</span>
                            </div>
                            <div class="comp-bar"><div class="comp-fill water" id="waterBar"></div></div>
                        </div>
                        <div class="comp-item">
                            <div class="comp-header">
                                <span class="comp-label">🦴 Bone Mass</span>
                                <span class="comp-value" id="measurementBone">--</span>
                                <span class="comp-unit">kg</span>
                            </div>
                            <div class="comp-bar"><div class="comp-fill bone" id="boneBar"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Health Indicators -->
                <div class="health-indicators">
                    <h3>Health Indicators</h3>
                    <div class="indicator-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="indicator-card">
                            <div class="indicator-icon emoji-icon">🎂</div>
                            <div class="indicator-value" id="measurementMetabolicAge">--</div>
                            <div class="indicator-label">Metabolic Age</div>
                            <div class="indicator-sub">years</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-icon emoji-icon">🎯</div>
                            <div class="indicator-value" id="measurementVisceralFat">--</div>
                            <div class="indicator-label">Visceral Fat</div>
                            <div class="indicator-sub" id="visceralStatus">level</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-icon emoji-icon">⚡</div>
                            <div class="indicator-value" id="measurementBMR">--</div>
                            <div class="indicator-label">BMR</div>
                            <div class="indicator-sub">kcal/day</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="closeSettingsModal(event)">
        <div class="modal settings-modal" onclick="event.stopPropagation()">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                <h2>⚙️ Settings</h2>
                <span id="settingsModalSubtitle" style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">Configure your health targets</span>
                <button type="button" class="modal-close" onclick="closeSettingsModal()" aria-label="Close settings">×</button>
            </div>
            <div class="modal-body">
                <!-- Body Measurements -->
                <div class="settings-section">
                    <h3>📏 Body Measurements</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="settingHeight">Height (cm)</label>
                            <input type="number" id="settingHeight" step="1" min="100" max="250" placeholder="175">
                        </div>
                    </div>
                </div>

                <!-- Daily Nutrition Targets -->
                <div class="settings-section">
                    <h3>🎯 Daily Nutrition Targets</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="settingCalories">Calories (kcal)</label>
                            <input type="number" id="settingCalories" step="50" min="1000" max="5000" placeholder="2000">
                        </div>
                        <div class="setting-item">
                            <label for="settingProtein">Protein (g)</label>
                            <input type="number" id="settingProtein" step="1" min="30" max="300" placeholder="150">
                        </div>
                        <div class="setting-item">
                            <label for="settingCarbs">Carbs (g)</label>
                            <input type="number" id="settingCarbs" step="1" min="50" max="500" placeholder="250">
                        </div>
                        <div class="setting-item">
                            <label for="settingFat">Fat (g)</label>
                            <input type="number" id="settingFat" step="1" min="20" max="200" placeholder="65">
                        </div>
                    </div>
                </div>

                <!-- Quick Presets -->
                <div class="settings-section">
                    <h3>⚡ Quick Presets</h3>
                    <div class="preset-buttons">
                        <button type="button" class="preset-btn" onclick="applyPreset('maintenance')">Maintenance</button>
                        <button type="button" class="preset-btn" onclick="applyPreset('cutting')">Weight Loss</button>
                        <button type="button" class="preset-btn" onclick="applyPreset('bulking')">Muscle Gain</button>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="settings-actions">
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">💾 Save Settings</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Food Detail Modal -->
    <div class="modal-overlay" id="foodDetailModal" onclick="closeFoodDetailModal(event)">
        <div class="modal food-modal" onclick="event.stopPropagation()">
            <div class="modal-header" style="background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);">
                <h2>Food Details</h2>
                <span id="foodModalDate" style="color: #1a1a2e !important; font-weight: 700 !important; font-size: 1.1rem !important; opacity: 1 !important; display: block;">--</span>
                <button type="button" class="modal-close" onclick="closeFoodDetailModal()" aria-label="Close food details modal">×</button>
            </div>
            <div class="modal-body">
                <!-- Food Hero -->
                <div class="metric-hero food-hero">
                    <div class="hero-metric">
                        <div class="hero-icon emoji-icon">🍽️</div>
                        <div class="hero-value" id="foodModalName">--</div>
                        <div class="hero-label">Food Item</div>
                    </div>
                </div>

                <!-- Basic Info -->
                <div class="food-info-section">
                    <div class="food-info-row">
                        <span class="food-info-label">📁 Category</span>
                        <span class="food-info-value" id="foodModalCategory">--</span>
                    </div>
                    <div class="food-info-row">
                        <span class="food-info-label">⚖️ Amount</span>
                        <span class="food-info-value" id="foodModalAmount">--</span>
                    </div>
                    <div class="food-info-row">
                        <span class="food-info-label">📅 Meal Group</span>
                        <span class="food-info-value" id="foodModalGroup">--</span>
                    </div>
                </div>

                <!-- Nutrition Summary -->
                <div class="food-nutrition-section">
                    <h3>🔥 Nutrition Facts</h3>
                    <div class="food-nutrition-grid">
                        <div class="food-nutrition-card calories">
                            <div class="nutrition-icon">🔥</div>
                            <div class="nutrition-value" id="foodModalCalories">--</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="food-nutrition-card protein">
                            <div class="nutrition-icon">🥩</div>
                            <div class="nutrition-value" id="foodModalProtein">--</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="food-nutrition-card carbs">
                            <div class="nutrition-icon">🍞</div>
                            <div class="nutrition-value" id="foodModalCarbs">--</div>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="food-nutrition-card fat">
                            <div class="nutrition-icon">🥑</div>
                            <div class="nutrition-value" id="foodModalFat">--</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                    </div>
                </div>

                <!-- Additional Nutrients -->
                <div class="food-extra-section">
                    <h3>📊 Additional Nutrients</h3>
                    <div class="food-extra-grid">
                        <div class="food-extra-item">
                            <span class="extra-label">Fiber</span>
                            <span class="extra-value" id="foodModalFiber">--</span>
                        </div>
                        <div class="food-extra-item">
                            <span class="extra-label">Sugar</span>
                            <span class="extra-value" id="foodModalSugar">--</span>
                        </div>
                        <div class="food-extra-item">
                            <span class="extra-label">Sodium</span>
                            <span class="extra-value" id="foodModalSodium">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // API Configuration
        // ============================================
        // In production (Azure), use the Functions URL; locally use localhost:7071
        const API_BASE = window.location.hostname.includes('azurestaticapps.net') 
            ? 'https://func-healthaggregator.azurewebsites.net' 
            : 'http://localhost:7071';
        
        // ============================================
        // Global State
        // ============================================
        let picoocData = [];
        let ouraData = { sleepRecords: [], dailySleep: [], readiness: [], activity: [] };
        let cronometerData = { dailyNutrition: [], servings: [], exercises: [], biometrics: [], notes: [] };
        let picoocChart = null;
        let ouraChart = null;
        let sleepChart = null;
        let dashboardChart = null;
        let macroChart = null;
        let calorieTrendChart = null;
        let picoocTimeRange = 'all';
        let ouraTimeRange = '1y';
        let picoocCurrentPage = 1;
        const picoocPageSize = 15;
        
        // Helper to get local date string (YYYY-MM-DD) avoiding timezone issues
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        let foodSelectedDate = getLocalDateString();

        // ============================================
        // Tab Navigation
        // ============================================
        function switchTab(tabName, btn) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Refresh dashboard if switching to it
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        // ============================================
        // Initialization
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize event listeners
            initEventListeners();
            
            // Load data
            loadPicoocData();
            loadOuraData();
            loadCronometerData();
            checkPicoocStatus();
            checkOuraStatus();
            checkCronometerStatus();
            
            // Set dashboard date
            document.getElementById('dashboardDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        });

        // ============================================
        // Event Listeners Setup
        // ============================================
        function initEventListeners() {
            // Tab navigation
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    switchTab(tabName, e.currentTarget);
                });
            });

            // Sync buttons
            document.getElementById('syncBtn').addEventListener('click', syncPicoocData);
            document.getElementById('ouraSyncBtn').addEventListener('click', syncOuraData);
            document.getElementById('syncFoodBtn').addEventListener('click', syncCronometerData);

            // Food date navigation
            document.getElementById('foodPrevDay').addEventListener('click', () => navigateFoodDate(-1));
            document.getElementById('foodNextDay').addEventListener('click', () => navigateFoodDate(1));

            // Time range buttons - Picooc
            document.getElementById('picooc-time-selector').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-range]');
                if (btn) {
                    setPicoocTimeRange(btn.dataset.range, btn);
                }
            });

            // Time range buttons - Oura
            document.getElementById('oura-time-selector').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-range]');
                if (btn) {
                    setOuraTimeRange(btn.dataset.range, btn);
                }
            });

            // Chart toggles - Picooc
            document.querySelector('[data-chart="picooc"]').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    updatePicoocChart();
                }
            });

            // Chart toggles - Oura
            document.querySelector('[data-chart="oura"]').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    updateOuraChart();
                }
            });

            // Chart toggles - Sleep
            document.querySelector('[data-chart="sleep"]').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    updateSleepChart();
                }
            });

            // Modal close buttons and overlay clicks
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });

                // Close button
                const closeBtn = modal.querySelector('.modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => closeModal(modal.id));
                }

                // Prevent click propagation from modal content
                const modalContent = modal.querySelector('.modal');
                if (modalContent) {
                    modalContent.addEventListener('click', (e) => e.stopPropagation());
                }
            });

            // Table row clicks with event delegation - Picooc
            document.getElementById('picoocTableBody').addEventListener('click', (e) => {
                const row = e.target.closest('tr[data-index]');
                if (row) {
                    showMeasurementDetail(parseInt(row.dataset.index));
                }
            });
            
            // Pagination buttons - Picooc
            document.getElementById('picoocPrevBtn').addEventListener('click', picoocPrevPage);
            document.getElementById('picoocNextBtn').addEventListener('click', picoocNextPage);

            // Table row clicks with event delegation - Oura Sleep
            document.getElementById('ouraSleepTableBody').addEventListener('click', (e) => {
                const row = e.target.closest('tr[data-sleep-id]');
                if (row) {
                    openSleepDetail(row.dataset.sleepId);
                }
            });
        }

        // Generic modal close function
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // ============================================
        // Dashboard Functions
        // ============================================
        function updateDashboard() {
            updateDashboardMetrics();
            updateDashboardChart();
            updateInsights();
        }

        function updateDashboardMetrics() {
            // Update date
            document.getElementById('dashboardDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Weight metrics from Picooc
            if (picoocData.length > 0) {
                const getDate = (d) => new Date(d.date || d.Date);
                const getWeight = (d) => d.weight || d.Weight;
                const getBodyFat = (d) => d.bodyFat || d.BodyFat;
                const getBodyWater = (d) => d.bodyWater || d.BodyWater;
                const fmt = (v) => v != null ? parseFloat(v).toFixed(1) : '--';
                
                const sortedPicooc = [...picoocData].sort((a, b) => getDate(b) - getDate(a));
                const latest = sortedPicooc[0];
                
                // Current weight
                const currentWeight = getWeight(latest);
                if (currentWeight) {
                    document.getElementById('dashWeight').innerHTML = `${fmt(currentWeight)}<span class="metric-unit"> kg</span>`;
                    document.getElementById('dashWeightDate').textContent = getDate(latest).toLocaleDateString();
                    
                    // Calculate progress
                    calculateProgress('weight', sortedPicooc, getWeight, getDate, true);
                }
                
                // Body Fat
                const currentBodyFat = getBodyFat(latest);
                if (currentBodyFat) {
                    document.getElementById('dashBodyFat').innerHTML = `${fmt(currentBodyFat)}<span class="metric-unit">%</span>`;
                    document.getElementById('dashBodyFatDate').textContent = getDate(latest).toLocaleDateString();
                    
                    calculateProgress('bodyFat', sortedPicooc, getBodyFat, getDate, true);
                }
            }
            
            // Update Kcal quick stat from Cronometer
            updateDashboardKcal();

            // Sleep metrics from Oura
            if (ouraData.dailySleep && ouraData.dailySleep.length > 0) {
                const sortedSleep = [...ouraData.dailySleep].sort((a, b) => new Date(b.day || b.Day) - new Date(a.day || a.Day));
                const latest = sortedSleep[0];
                const score = latest.score ?? latest.Score;
                const day = latest.day || latest.Day;
                
                if (score) {
                    document.getElementById('dashSleepScore').textContent = score;
                    document.getElementById('dashSleepDate').textContent = new Date(day).toLocaleDateString();
                    
                    calculateProgress('sleep', sortedSleep, d => d.score ?? d.Score, d => new Date(d.day || d.Day), false);
                }
            }

            // Readiness from Oura
            if (ouraData.readiness && ouraData.readiness.length > 0) {
                const sortedReadiness = [...ouraData.readiness].sort((a, b) => new Date(b.day || b.Day) - new Date(a.day || a.Day));
                const latest = sortedReadiness[0];
                const score = latest.score ?? latest.Score;
                const day = latest.day || latest.Day;
                
                if (score) {
                    document.getElementById('dashReadiness').textContent = score;
                    document.getElementById('dashReadinessDate').textContent = new Date(day).toLocaleDateString();
                    
                    calculateProgress('readiness', sortedReadiness, d => d.score ?? d.Score, d => new Date(d.day || d.Day), false);
                }
            }

            // Activity (Steps) from Oura
            if (ouraData.activity && ouraData.activity.length > 0) {
                const sortedActivity = [...ouraData.activity].sort((a, b) => new Date(b.day) - new Date(a.day));
                const latest = sortedActivity[0];
                
                if (latest.steps) {
                    document.getElementById('dashSteps').textContent = latest.steps.toLocaleString();
                }
            }

            // Sleep Duration from Sleep Records (only long_sleep, not naps)
            if (ouraData.sleepRecords && ouraData.sleepRecords.length > 0) {
                // Filter for long sleep only (exclude naps)
                const longSleepRecords = ouraData.sleepRecords.filter(r => r.type === 'long_sleep');
                const sortedSleepRecords = [...longSleepRecords].sort((a, b) => new Date(b.day) - new Date(a.day));
                
                if (sortedSleepRecords.length > 0) {
                    const latest = sortedSleepRecords[0];
                    
                    if (latest.totalSleepDuration) {
                        document.getElementById('dashSleepDuration').textContent = formatDuration(latest.totalSleepDuration);
                    }
                    
                    if (latest.averageHeartRate) {
                        document.getElementById('dashAvgHR').textContent = `${Math.round(latest.averageHeartRate)} bpm`;
                    }
                }
            }
        }

        async function updateDashboardKcal() {
            const settings = await getSettings();
            const dailyTarget = settings.calories;
            
            const nutrition = cronometerData.dailyNutrition || [];
            const today = new Date().toISOString().split('T')[0];
            const todayNutrition = nutrition.find(n => n.Date === today);
            const todayCalories = Math.round(todayNutrition?.Energy || 0);
            
            const quickEl = document.getElementById('dashKcalQuick');
            if (quickEl) {
                quickEl.textContent = `${todayCalories.toLocaleString()} / ${dailyTarget.toLocaleString()}`;
                // Color coding
                if (todayCalories > dailyTarget) {
                    quickEl.style.color = '#ff6b6b';
                } else if (todayCalories >= dailyTarget * 0.9) {
                    quickEl.style.color = '#ffa94d';
                } else {
                    quickEl.style.color = '';
                }
            }
        }

        function calculateProgress(metricType, data, getValue, getDate, lowerIsBetter) {
            if (!data || data.length < 2) return; // Need at least 2 records to compare
            
            const latestDate = getDate(data[0]);
            const current = getValue(data[0]);
            if (!current) return;
            
            // Find the value at approximately N days before the latest record
            // minDays/maxDays define the acceptable range
            const findValueInRange = (minDays, maxDays) => {
                let bestMatch = null;
                let bestDaysDiff = Infinity;
                const targetDays = (minDays + maxDays) / 2;
                
                // Skip the first record (that's our current value)
                for (let i = 1; i < data.length; i++) {
                    const item = data[i];
                    const itemDate = getDate(item);
                    const val = getValue(item);
                    
                    // Skip if no value
                    if (!val) continue;
                    
                    // Days between this record and the latest record
                    const daysSinceLatest = (latestDate.getTime() - itemDate.getTime()) / (24 * 60 * 60 * 1000);
                    
                    // Check if within range
                    if (daysSinceLatest >= minDays && daysSinceLatest <= maxDays) {
                        // Prefer the one closest to target
                        const diff = Math.abs(daysSinceLatest - targetDays);
                        if (diff < bestDaysDiff) {
                            bestMatch = val;
                            bestDaysDiff = diff;
                        }
                    }
                }
                
                // If no match in range, find closest record that's at least minDays old
                if (!bestMatch) {
                    for (let i = 1; i < data.length; i++) {
                        const item = data[i];
                        const itemDate = getDate(item);
                        const val = getValue(item);
                        
                        if (!val) continue;
                        
                        const daysSinceLatest = (latestDate.getTime() - itemDate.getTime()) / (24 * 60 * 60 * 1000);
                        
                        // Only consider records at least minDays old
                        if (daysSinceLatest >= minDays) {
                            const diff = Math.abs(daysSinceLatest - targetDays);
                            if (diff < bestDaysDiff) {
                                bestMatch = val;
                                bestDaysDiff = diff;
                            }
                        }
                    }
                }
                
                return bestMatch;
            };
            
            // Find previous record (for "yesterday" - just the previous measurement)
            const findPreviousRecord = () => {
                for (let i = 1; i < data.length; i++) {
                    const val = getValue(data[i]);
                    if (val) return val;
                }
                return null;
            };
            
            const yesterdayVal = findPreviousRecord(); // Previous measurement
            const weekVal = findValueInRange(5, 14); // ~1 week: 5-14 days range
            const monthVal = findValueInRange(21, 45); // ~1 month: 21-45 days range
            
            updateProgressDisplay(metricType, 'Yesterday', yesterdayVal, current, lowerIsBetter);
            updateProgressDisplay(metricType, 'Week', weekVal, current, lowerIsBetter);
            updateProgressDisplay(metricType, 'Month', monthVal, current, lowerIsBetter);
        }

        function updateProgressDisplay(metricType, period, oldValue, newValue, lowerIsBetter) {
            const changeEl = document.getElementById(`${metricType}Vs${period}`);
            const absEl = document.getElementById(`${metricType}${period}Abs`);
            
            if (!oldValue || !newValue) {
                changeEl.textContent = '--';
                changeEl.className = 'change neutral';
                if (absEl) absEl.textContent = '';
                return;
            }
            
            const diff = newValue - oldValue;
            const pctChange = (diff / oldValue) * 100;
            const pctDisplay = Math.abs(pctChange).toFixed(1);
            
            let changeClass = 'neutral';
            let arrow = '→';
            
            if (Math.abs(pctChange) < 0.05) {
                // Essentially no change (less than 0.05%)
                changeClass = 'neutral';
                arrow = '→';
            } else if (lowerIsBetter) {
                // For weight/body fat, lower is better
                changeClass = diff < 0 ? 'positive' : 'negative';
                arrow = diff < 0 ? '↓' : '↑';
            } else {
                // For scores, higher is better
                changeClass = diff > 0 ? 'positive' : 'negative';
                arrow = diff > 0 ? '↑' : '↓';
            }
            
            changeEl.textContent = `${arrow} ${pctDisplay}%`;
            changeEl.className = `change ${changeClass}`;
            
            if (absEl) {
                const sign = diff > 0 ? '+' : '';
                absEl.textContent = `${sign}${diff.toFixed(1)}`;
            }
        }

        function updateDashboardChart() {
            const canvas = document.getElementById('dashboardChart');
            const ctx = canvas.getContext('2d');
            
            if (dashboardChart) {
                dashboardChart.destroy();
                dashboardChart = null;
            }
            
            // Get last 7 days of data
            const dates = [];
            const now = new Date();
            for (let i = 6; i >= 0; i--) {
                const d = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                dates.push(d.toISOString().split('T')[0]);
            }
            
            const sleepMap = {};
            const readinessMap = {};
            const weightMap = {};
            
            if (ouraData.dailySleep) {
                ouraData.dailySleep.forEach(d => { sleepMap[d.day] = d.score; });
            }
            if (ouraData.readiness) {
                ouraData.readiness.forEach(d => { readinessMap[d.day] = d.score; });
            }
            if (picoocData.length > 0) {
                picoocData.forEach(d => {
                    const date = new Date(d.date || d.Date).toISOString().split('T')[0];
                    const weight = d.weight || d.Weight;
                    if (weight) weightMap[date] = weight;
                });
            }
            
            const labels = dates.map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
            
            const datasets = [];
            
            // Only add datasets that have data
            const sleepData = dates.map(d => sleepMap[d] || null);
            const readinessData = dates.map(d => readinessMap[d] || null);
            const weightData = dates.map(d => weightMap[d] || null);
            
            // Three simple lines - no fill, all on single Y axis (Score/kg 1:1)
            if (sleepData.some(v => v !== null)) {
                datasets.push({
                    label: 'Sleep Score',
                    data: sleepData,
                    borderColor: '#3b82f6',
                    backgroundColor: '#3b82f6',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.3,
                    fill: false
                });
            }
            
            if (readinessData.some(v => v !== null)) {
                datasets.push({
                    label: 'Readiness',
                    data: readinessData,
                    borderColor: '#22c55e',
                    backgroundColor: '#22c55e',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.3,
                    fill: false
                });
            }
            
            if (weightData.some(v => v !== null)) {
                datasets.push({
                    label: 'Weight (kg)',
                    data: weightData,
                    borderColor: '#00d4ff',
                    backgroundColor: '#00d4ff',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.3,
                    fill: false
                });
            }
            
            if (datasets.length === 0) {
                return;
            }
            
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            labels: { color: '#aaa' },
                            position: 'top'
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#888' } 
                        },
                        y: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left', 
                            min: 0, 
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#aaa' },
                            title: { display: true, text: 'Score / Weight (kg)', color: '#aaa' }
                        }
                    }
                }
            });
        }

        function updateInsights() {
            const insightsList = document.getElementById('insightsList');
            const insights = [];
            const now = new Date();
            
            // Weight insights - compare latest with ~1 week ago record
            if (picoocData.length > 1) {
                const getWeight = (d) => d.weight || d.Weight;
                const getDate = (d) => new Date(d.date || d.Date);
                const sorted = [...picoocData].filter(d => getWeight(d)).sort((a, b) => getDate(b) - getDate(a));
                
                if (sorted.length >= 2) {
                    const latest = sorted[0];
                    const latestWeight = getWeight(latest);
                    const latestDate = getDate(latest);
                    
                    // Find record closest to 7 days before latest
                    let weekAgoRecord = null;
                    let closestDiff = Infinity;
                    
                    for (let i = 1; i < sorted.length; i++) {
                        const recordDate = getDate(sorted[i]);
                        const daysDiff = (latestDate - recordDate) / (24 * 60 * 60 * 1000);
                        const diffFrom7 = Math.abs(daysDiff - 7);
                        
                        if (daysDiff >= 5 && daysDiff <= 14 && diffFrom7 < closestDiff) {
                            weekAgoRecord = sorted[i];
                            closestDiff = diffFrom7;
                        }
                    }
                    
                    if (weekAgoRecord) {
                        const weekAgoWeight = getWeight(weekAgoRecord);
                        const diff = latestWeight - weekAgoWeight;
                        const daysBetween = Math.round((latestDate - getDate(weekAgoRecord)) / (24 * 60 * 60 * 1000));
                        
                        if (diff < -0.3) {
                            insights.push({ icon: '🎉', text: `Great progress! You've lost ${Math.abs(diff).toFixed(1)}kg over the past ${daysBetween} days.`, type: 'positive' });
                        } else if (diff > 0.3) {
                            insights.push({ icon: '📈', text: `Your weight increased by ${diff.toFixed(1)}kg over the past ${daysBetween} days.`, type: 'info' });
                        } else {
                            insights.push({ icon: '✨', text: `Your weight has been stable (${parseFloat(latestWeight).toFixed(1)}kg) over the past ${daysBetween} days.`, type: 'positive' });
                        }
                    }
                    
                    // Also show current weight
                    insights.push({ icon: '⚖️', text: `Current weight: ${parseFloat(latestWeight).toFixed(1)}kg (measured ${latestDate.toLocaleDateString()})`, type: 'info' });
                }
            }
            
            // Sleep insights
            if (ouraData.dailySleep && ouraData.dailySleep.length > 0) {
                const sorted = [...ouraData.dailySleep].filter(d => d.score).sort((a, b) => new Date(b.day) - new Date(a.day));
                const latestScore = sorted[0]?.score;
                
                if (latestScore) {
                    if (latestScore >= 85) {
                        insights.push({ icon: '😴', text: `Excellent sleep score of ${latestScore}! You're well-rested.`, type: 'positive' });
                    } else if (latestScore < 70) {
                        insights.push({ icon: '💤', text: `Your sleep score is ${latestScore}. Try going to bed earlier tonight.`, type: 'warning' });
                    }
                }
                
                // Check sleep consistency
                if (sorted.length >= 7) {
                    const weekScores = sorted.slice(0, 7).map(d => d.score).filter(s => s);
                    const avgScore = weekScores.reduce((a, b) => a + b, 0) / weekScores.length;
                    insights.push({ icon: '📊', text: `Your 7-day average sleep score is ${Math.round(avgScore)}.`, type: 'info' });
                }
            }
            
            // Readiness insights
            if (ouraData.readiness && ouraData.readiness.length > 0) {
                const latest = [...ouraData.readiness].sort((a, b) => new Date(b.day) - new Date(a.day))[0];
                if (latest?.score) {
                    if (latest.score >= 85) {
                        insights.push({ icon: '⚡', text: `High readiness score of ${latest.score}! Great day for intense activity.`, type: 'positive' });
                    } else if (latest.score < 70) {
                        insights.push({ icon: '🧘', text: `Readiness is at ${latest.score}. Consider a lighter workout or rest day.`, type: 'warning' });
                    }
                }
            }
            
            // Activity insights
            if (ouraData.activity && ouraData.activity.length > 0) {
                const sorted = [...ouraData.activity].sort((a, b) => new Date(b.day) - new Date(a.day));
                const latest = sorted[0];
                
                if (latest?.steps) {
                    if (latest.steps >= 10000) {
                        insights.push({ icon: '🏆', text: `You hit ${latest.steps.toLocaleString()} steps! Keep up the great work!`, type: 'positive' });
                    } else if (latest.steps < 5000) {
                        insights.push({ icon: '👟', text: `Only ${latest.steps.toLocaleString()} steps so far. Try a short walk!`, type: 'warning' });
                    }
                }
            }
            
            // Display insights
            if (insights.length > 0) {
                insightsList.innerHTML = insights.map(i => `
                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; 
                                background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 10px;
                                border-left: 3px solid ${i.type === 'positive' ? '#22c55e' : i.type === 'warning' ? '#f59e0b' : '#3b82f6'};">
                        <span style="font-size: 1.5rem;">${i.icon}</span>
                        <span style="color: #ccc; line-height: 1.5;">${i.text}</span>
                    </div>
                `).join('');
            } else {
                insightsList.innerHTML = '<div class="no-data-message">Sync your data to get personalized insights</div>';
            }
        }

        // ============================================
        // Picooc Functions
        // ============================================
        async function checkPicoocStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/picooc/status`);
                const status = await response.json();
                
                const statusEl = document.getElementById('statusMessage');
                if (!status.configured) {
                    if (!status.hasCredentials) {
                        statusEl.className = 'status warning';
                        statusEl.textContent = '⚠️ Credentials not configured';
                    } else if (!status.hasDocker) {
                        statusEl.className = 'status warning';
                        statusEl.textContent = '⚠️ Docker not available';
                    }
                } else {
                    statusEl.className = 'status success';
                    const lastSync = status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
                    statusEl.textContent = `✅ Connected (${status.dataCount} records, Last sync: ${lastSync})`;
                }
            } catch (e) {
                console.error('Status check failed:', e);
            }
        }

        async function loadPicoocData() {
            try {
                const response = await fetch(`${API_BASE}/api/picooc/data`);
                const result = await response.json();
                picoocData = result.data || result || [];
                updatePicoocUI();
                loadPicoocStats();
                updateDashboard(); // Update dashboard with new data
            } catch (e) {
                console.error('Failed to load Picooc data:', e);
            }
        }

        async function loadPicoocStats() {
            try {
                const response = await fetch(`${API_BASE}/api/picooc/stats`);
                const stats = await response.json();
                
                if (stats.weight) {
                    document.getElementById('currentWeight').textContent = stats.weight.current + ' kg';
                    document.getElementById('weightDetails').textContent = 
                        `Min: ${stats.weight.min} | Max: ${stats.weight.max} | Avg: ${stats.weight.avg}`;
                }
                
                if (stats.bodyFat) {
                    document.getElementById('currentBodyFat').textContent = stats.bodyFat.current + '%';
                    document.getElementById('bodyFatDetails').textContent = 
                        `Min: ${stats.bodyFat.min} | Max: ${stats.bodyFat.max} | Avg: ${stats.bodyFat.avg}`;
                }
                
                if (stats.bmi) {
                    document.getElementById('currentBMI').textContent = stats.bmi.current;
                    document.getElementById('bmiDetails').textContent = 
                        `Min: ${stats.bmi.min} | Max: ${stats.bmi.max} | Avg: ${stats.bmi.avg}`;
                }
                
                if (stats.muscle) {
                    document.getElementById('currentMuscle').textContent = stats.muscle.current + ' kg';
                    document.getElementById('muscleDetails').textContent = 
                        `Min: ${stats.muscle.min} | Max: ${stats.muscle.max} | Avg: ${stats.muscle.avg}`;
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function syncPicoocData() {
            const btn = document.getElementById('syncBtn');
            const statusEl = document.getElementById('statusMessage');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Syncing...';
            statusEl.className = 'status';
            statusEl.textContent = 'Connecting to Picooc...';
            
            try {
                const response = await fetch(`${API_BASE}/api/picooc/sync`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    // Reload data from API to get properly formatted data
                    await loadPicoocData();
                    statusEl.className = 'status success';
                    statusEl.textContent = `✅ Synced ${result.data?.length || 0} measurements`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = `❌ ${result.error || 'Unknown error'}`;
                }
            } catch (e) {
                statusEl.className = 'status error';
                statusEl.textContent = `❌ Sync failed: ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '🔄 Sync Data';
            }
        }

        function updatePicoocUI() {
            updatePicoocChart();
            updatePicoocTable();
        }

        function setPicoocTimeRange(range, btn) {
            picoocTimeRange = range;
            document.querySelectorAll('#picooc-time-selector .time-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updatePicoocChart();
        }

        function filterDataByTimeRange(data, range, getDateFn) {
            if (range === 'all') return data;
            
            const now = new Date();
            let cutoffDate;
            
            switch (range) {
                case '7d': cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case '30d': cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); break;
                case '90d': cutoffDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000); break;
                case '6m': cutoffDate = new Date(new Date().setMonth(new Date().getMonth() - 6)); break;
                case '1y': cutoffDate = new Date(new Date().setFullYear(new Date().getFullYear() - 1)); break;
                case '2y': cutoffDate = new Date(new Date().setFullYear(new Date().getFullYear() - 2)); break;
                default: return data;
            }
            
            return data.filter(d => getDateFn(d) >= cutoffDate);
        }

        function updatePicoocChart() {
            const canvas = document.getElementById('picoocChart');
            const ctx = canvas.getContext('2d');
            
            const showWeight = document.getElementById('showWeight').checked;
            const showBodyFat = document.getElementById('showBodyFat').checked;
            const showBMI = document.getElementById('showBMI').checked;
            const showMuscle = document.getElementById('showMuscle').checked;
            
            if (picoocChart) {
                picoocChart.destroy();
                picoocChart = null;
            }
            
            if (picoocData.length === 0) return;
            
            const getVal = (d, key1, key2) => {
                const v = d[key1] ?? d[key2];
                return (v && v > 0) ? v : null;
            };
            const getDate = (d) => new Date(d.date || d.Date);
            
            const filteredData = filterDataByTimeRange(picoocData, picoocTimeRange, getDate);
            const sortedData = [...filteredData].filter(d => d.date || d.Date).sort((a, b) => getDate(a) - getDate(b));
            
            if (sortedData.length === 0) return;
            
            const labelFormat = ['7d', '30d'].includes(picoocTimeRange) 
                ? { month: 'short', day: 'numeric' }
                : { month: 'short', year: '2-digit' };
            
            const labels = sortedData.map(d => getDate(d).toLocaleDateString('en-US', labelFormat));
            const datasets = [];
            
            if (showWeight) {
                datasets.push({
                    label: 'Weight (kg)', data: sortedData.map(d => getVal(d, 'Weight', 'weight')),
                    borderColor: '#00d4ff', backgroundColor: '#00d4ff', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            if (showBodyFat) {
                datasets.push({
                    label: 'Body Fat (%)', data: sortedData.map(d => getVal(d, 'BodyFat', 'bodyFat')),
                    borderColor: '#f472b6', backgroundColor: '#f472b6', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y1'
                });
            }
            
            if (showBMI) {
                datasets.push({
                    label: 'BMI', data: sortedData.map(d => getVal(d, 'BMI', 'bmi')),
                    borderColor: '#a78bfa', backgroundColor: '#a78bfa', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y1'
                });
            }
            
            if (showMuscle) {
                datasets.push({
                    label: 'Muscle Mass (kg)', data: sortedData.map(d => getVal(d, 'SkeletalMuscleMass', 'skeletalMuscleMass')),
                    borderColor: '#34d399', backgroundColor: '#34d399', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            picoocChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#aaa' } } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888', maxRotation: 45, autoSkip: true, maxTicksLimit: 12 } },
                        y: { type: 'linear', display: true, position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#00d4ff' }, title: { display: true, text: 'kg', color: '#00d4ff' } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#f472b6' }, title: { display: true, text: '% / BMI', color: '#f472b6' } }
                    }
                }
            });
        }

        function updatePicoocTable() {
            const tbody = document.getElementById('picoocTableBody');
            const pagination = document.getElementById('picoocPagination');
            const prevBtn = document.getElementById('picoocPrevBtn');
            const nextBtn = document.getElementById('picoocNextBtn');
            const pageInfo = document.getElementById('picoocPageInfo');
            
            if (picoocData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><h3>No data yet</h3><p>Click "Sync Data" to fetch your measurements</p></td></tr>`;
                pagination.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(picoocData.length / picoocPageSize);
            picoocCurrentPage = Math.min(picoocCurrentPage, totalPages);
            picoocCurrentPage = Math.max(picoocCurrentPage, 1);
            
            const startIndex = (picoocCurrentPage - 1) * picoocPageSize;
            const endIndex = startIndex + picoocPageSize;
            const pageData = picoocData.slice(startIndex, endIndex);
            
            // Helper to format numbers to 1 decimal place
            const fmt = (v) => v != null && v !== '--' ? parseFloat(v).toFixed(1) : '--';
            const fmtInt = (v) => v != null && v !== '--' ? Math.round(parseFloat(v)) : '--';
            
            tbody.innerHTML = pageData.map((d, i) => {
                const actualIndex = startIndex + i;
                return `
                <tr data-index="${actualIndex}" style="cursor: pointer;" title="Click for details">
                    <td>${new Date(d.date || d.Date).toLocaleString()}</td>
                    <td>${fmt(d.weight || d.Weight)}</td>
                    <td>${fmt(d.bodyFat || d.BodyFat)}</td>
                    <td>${fmt(d.bmi || d.BMI)}</td>
                    <td>${fmt(d.skeletalMuscleMass || d.SkeletalMuscleMass)}</td>
                    <td>${fmt(d.bodyWater || d.BodyWater)}</td>
                    <td>${fmtInt(d.metabolicAge || d.MetabolicAge)}</td>
                </tr>
            `}).join('');
            
            // Update pagination controls
            pagination.style.display = 'flex';
            pageInfo.textContent = `Page ${picoocCurrentPage} of ${totalPages}`;
            prevBtn.disabled = picoocCurrentPage <= 1;
            nextBtn.disabled = picoocCurrentPage >= totalPages;
        }
        
        function picoocPrevPage() {
            if (picoocCurrentPage > 1) {
                picoocCurrentPage--;
                updatePicoocTable();
            }
        }
        
        function picoocNextPage() {
            const totalPages = Math.ceil(picoocData.length / picoocPageSize);
            if (picoocCurrentPage < totalPages) {
                picoocCurrentPage++;
                updatePicoocTable();
            }
        }

        // ============================================
        // Oura Functions
        // ============================================
        async function checkOuraStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/oura/status`);
                const status = await response.json();
                
                const statusEl = document.getElementById('ouraStatusMessage');
                if (!status.configured) {
                    statusEl.className = 'status warning';
                    statusEl.textContent = '⚠️ Oura access token not configured in appsettings.json';
                } else {
                    statusEl.className = 'status success';
                    const lastSync = status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
                    statusEl.textContent = `✅ Connected (${status.dataCount} records, Last sync: ${lastSync})`;
                }
            } catch (e) {
                console.error('Oura status check failed:', e);
            }
        }

        // Helper to normalize property names from PascalCase to camelCase
        function normalizeOuraRecord(record) {
            if (!record) return record;
            const normalized = {};
            for (const [key, value] of Object.entries(record)) {
                const camelKey = key.charAt(0).toLowerCase() + key.slice(1);
                normalized[camelKey] = value;
            }
            return normalized;
        }

        async function loadOuraData() {
            try {
                const response = await fetch(`${API_BASE}/api/oura/data`);
                const data = await response.json();
                // Normalize all records to camelCase
                ouraData = {
                    sleepRecords: (data.sleepRecords || []).map(normalizeOuraRecord),
                    dailySleep: (data.dailySleep || []).map(normalizeOuraRecord),
                    readiness: (data.readiness || []).map(normalizeOuraRecord),
                    activity: (data.activity || []).map(normalizeOuraRecord)
                };
                updateOuraUI();
                loadOuraStats();
                updateDashboard(); // Update dashboard with new data
            } catch (e) {
                console.error('Failed to load Oura data:', e);
            }
        }

        async function loadOuraStats() {
            try {
                const response = await fetch(`${API_BASE}/api/oura/stats`);
                const stats = await response.json();
                
                if (stats.averageSleepScore) {
                    document.getElementById('ouraSleepScore').textContent = Math.round(stats.averageSleepScore);
                    document.getElementById('ouraSleepDetails').textContent = `${stats.totalSleepRecords} records`;
                }
                
                if (stats.averageReadinessScore) {
                    document.getElementById('ouraReadinessScore').textContent = Math.round(stats.averageReadinessScore);
                    document.getElementById('ouraReadinessDetails').textContent = `${stats.totalReadinessRecords} records`;
                }
                
                if (stats.averageActivityScore) {
                    document.getElementById('ouraActivityScore').textContent = Math.round(stats.averageActivityScore);
                    document.getElementById('ouraActivityDetails').textContent = `${stats.averageSteps || 0} avg steps`;
                }
                
                if (stats.averageSleepDuration) {
                    document.getElementById('ouraAvgSleep').textContent = `${stats.averageSleepDuration}h`;
                    document.getElementById('ouraAvgSleepDetails').textContent = `${stats.firstDate || ''} - ${stats.lastDate || ''}`;
                }
            } catch (e) {
                console.error('Failed to load Oura stats:', e);
            }
        }

        async function syncOuraData() {
            const btn = document.getElementById('ouraSyncBtn');
            const statusEl = document.getElementById('ouraStatusMessage');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Syncing...';
            statusEl.className = 'status';
            statusEl.textContent = 'Connecting to Oura API...';
            
            try {
                const response = await fetch(`${API_BASE}/api/oura/sync`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    // Reload data from API after successful sync
                    await loadOuraData();
                    statusEl.className = 'status success';
                    statusEl.textContent = `✅ Synced ${result.sleepCount || 0} sleep, ${result.readinessCount || 0} readiness, ${result.activityCount || 0} activity records`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = `❌ ${result.error || 'Unknown error'}`;
                }
            } catch (e) {
                statusEl.className = 'status error';
                statusEl.textContent = `❌ Sync failed: ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '🔄 Sync Oura Data';
            }
        }

        function updateOuraUI() {
            updateOuraChart();
            updateSleepChart();
            updateOuraTables();
        }

        function setOuraTimeRange(range, btn) {
            ouraTimeRange = range;
            document.querySelectorAll('#oura-time-selector .time-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateOuraChart();
            updateSleepChart();
        }

        function updateOuraChart() {
            const canvas = document.getElementById('ouraChart');
            const ctx = canvas.getContext('2d');
            
            const showSleep = document.getElementById('showSleepScore').checked;
            const showReadiness = document.getElementById('showReadinessScore').checked;
            const showActivity = document.getElementById('showActivityScore').checked;
            const showSteps = document.getElementById('showSteps').checked;
            
            if (ouraChart) {
                ouraChart.destroy();
                ouraChart = null;
            }
            
            // Combine all dates
            const allDates = [...new Set([
                ...ouraData.dailySleep.map(d => d.day),
                ...ouraData.readiness.map(d => d.day),
                ...ouraData.activity.map(d => d.day)
            ])].sort();
            
            if (allDates.length === 0) return;
            
            const getDate = (d) => new Date(d);
            const filteredDates = filterDataByTimeRange(allDates.map(d => ({ day: d })), ouraTimeRange, d => getDate(d.day)).map(d => d.day);
            
            if (filteredDates.length === 0) return;
            
            const sleepMap = Object.fromEntries(ouraData.dailySleep.map(d => [d.day, d.score]));
            const readinessMap = Object.fromEntries(ouraData.readiness.map(d => [d.day, d.score]));
            const activityMap = Object.fromEntries(ouraData.activity.map(d => [d.day, { score: d.score, steps: d.steps }]));
            
            const labels = filteredDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const datasets = [];
            
            if (showSleep) {
                datasets.push({
                    label: 'Sleep Score', data: filteredDates.map(d => sleepMap[d] || null),
                    borderColor: '#3b82f6', backgroundColor: '#3b82f6', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            if (showReadiness) {
                datasets.push({
                    label: 'Readiness Score', data: filteredDates.map(d => readinessMap[d] || null),
                    borderColor: '#22c55e', backgroundColor: '#22c55e', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            if (showActivity) {
                datasets.push({
                    label: 'Activity Score', data: filteredDates.map(d => activityMap[d]?.score || null),
                    borderColor: '#f59e0b', backgroundColor: '#f59e0b', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            if (showSteps) {
                datasets.push({
                    label: 'Steps', data: filteredDates.map(d => activityMap[d]?.steps || null),
                    borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y1'
                });
            }
            
            ouraChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#aaa' } } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888', maxRotation: 45, autoSkip: true, maxTicksLimit: 15 } },
                        y: { type: 'linear', display: true, position: 'left', min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#3b82f6' }, title: { display: true, text: 'Score', color: '#3b82f6' } },
                        y1: { type: 'linear', display: showSteps, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#8b5cf6' }, title: { display: true, text: 'Steps', color: '#8b5cf6' } }
                    }
                }
            });
        }

        function updateSleepChart() {
            const canvas = document.getElementById('sleepChart');
            const ctx = canvas.getContext('2d');
            
            const showTotal = document.getElementById('showTotalSleep').checked;
            const showDeep = document.getElementById('showDeepSleep').checked;
            const showRem = document.getElementById('showRemSleep').checked;
            const showHR = document.getElementById('showAvgHR').checked;
            
            if (sleepChart) {
                sleepChart.destroy();
                sleepChart = null;
            }
            
            // Filter for long_sleep only (exclude naps)
            const longSleepRecords = ouraData.sleepRecords.filter(r => r.type === 'long_sleep');
            
            if (longSleepRecords.length === 0) return;
            
            const getDate = (d) => new Date(d.day);
            const filteredData = filterDataByTimeRange(longSleepRecords, ouraTimeRange, getDate);
            const sortedData = [...filteredData].sort((a, b) => getDate(a) - getDate(b));
            
            if (sortedData.length === 0) return;
            
            const toHours = (seconds) => seconds ? Math.round(seconds / 3600 * 10) / 10 : null;
            const labels = sortedData.map(d => new Date(d.day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const datasets = [];
            
            if (showTotal) {
                datasets.push({
                    label: 'Total Sleep (h)', data: sortedData.map(d => toHours(d.totalSleepDuration)),
                    borderColor: '#3b82f6', backgroundColor: '#3b82f6', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            if (showDeep) {
                datasets.push({
                    label: 'Deep Sleep (h)', data: sortedData.map(d => toHours(d.deepSleepDuration)),
                    borderColor: '#1e40af', backgroundColor: '#1e40af', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            if (showRem) {
                datasets.push({
                    label: 'REM Sleep (h)', data: sortedData.map(d => toHours(d.remSleepDuration)),
                    borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y'
                });
            }
            
            if (showHR) {
                datasets.push({
                    label: 'Avg Heart Rate', data: sortedData.map(d => d.averageHeartRate || null),
                    borderColor: '#ef4444', backgroundColor: '#ef4444', borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 4, tension: 0.4, fill: false, spanGaps: true, yAxisID: 'y1'
                });
            }
            
            sleepChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#aaa' } } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888', maxRotation: 45, autoSkip: true, maxTicksLimit: 15 } },
                        y: { type: 'linear', display: true, position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#3b82f6' }, title: { display: true, text: 'Hours', color: '#3b82f6' } },
                        y1: { type: 'linear', display: showHR, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#ef4444' }, title: { display: true, text: 'BPM', color: '#ef4444' } }
                    }
                }
            });
        }

        function getScoreClass(score) {
            if (!score) return '';
            if (score >= 85) return 'score-good';
            if (score >= 70) return 'score-ok';
            return 'score-low';
        }

        function formatDuration(seconds) {
            if (!seconds) return '--';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${mins}m`;
        }

        function updateOuraTables() {
            // Sleep table - combine long_sleep records with dailySleep scores
            const sleepTbody = document.getElementById('ouraSleepTableBody');
            
            // Filter for long_sleep only
            const longSleepRecords = ouraData.sleepRecords.filter(r => r.type === 'long_sleep');
            
            // Create a combined list: start with long_sleep records, then add any dailySleep entries that don't have a matching long_sleep record
            const sleepWithScores = longSleepRecords.map(sleep => {
                const dailySleep = ouraData.dailySleep.find(d => d.day === sleep.day);
                return { ...sleep, score: dailySleep?.score, hasDetailedData: true };
            });
            
            // Add dailySleep entries that don't have a matching long_sleep record (shows score only)
            ouraData.dailySleep.forEach(daily => {
                const hasLongSleep = longSleepRecords.some(r => r.day === daily.day);
                if (!hasLongSleep) {
                    sleepWithScores.push({
                        id: daily.id,
                        day: daily.day,
                        score: daily.score,
                        totalSleepDuration: null,
                        deepSleepDuration: null,
                        remSleepDuration: null,
                        averageHeartRate: null,
                        averageHrv: null,
                        efficiency: null,
                        hasDetailedData: false
                    });
                }
            });
            
            if (sleepWithScores.length === 0) {
                sleepTbody.innerHTML = `<tr><td colspan="8" class="empty-state"><h3>No data yet</h3><p>Click "Sync Oura Data" to fetch your sleep data</p></td></tr>`;
            } else {
                // Sort by date descending
                sleepWithScores.sort((a, b) => new Date(b.day) - new Date(a.day));
                
                sleepTbody.innerHTML = sleepWithScores.slice(0, 30).map(d => `
                    <tr class="${d.hasDetailedData ? 'clickable-row' : ''}" ${d.hasDetailedData ? `data-sleep-id="${d.id}"` : ''} ${!d.hasDetailedData ? 'title="Detailed sleep data not yet available from Oura"' : ''}>
                        <td>${d.day}</td>
                        <td><span class="score-badge ${getScoreClass(d.score)}">${d.score || '--'}</span></td>
                        <td>${d.totalSleepDuration ? formatDuration(d.totalSleepDuration) : '--'}</td>
                        <td>${d.deepSleepDuration ? formatDuration(d.deepSleepDuration) : '--'}</td>
                        <td>${d.remSleepDuration ? formatDuration(d.remSleepDuration) : '--'}</td>
                        <td>${d.averageHeartRate ? Math.round(d.averageHeartRate) : '--'}</td>
                        <td>${d.averageHrv ? Math.round(d.averageHrv) : '--'}</td>
                        <td>${d.efficiency ? d.efficiency + '%' : '--'}</td>
                    </tr>
                `).join('');
            }
            
            // Activity table
            const activityTbody = document.getElementById('ouraActivityTableBody');
            
            if (ouraData.activity.length === 0) {
                activityTbody.innerHTML = `<tr><td colspan="8" class="empty-state"><h3>No data yet</h3><p>Click "Sync Oura Data" to fetch your activity data</p></td></tr>`;
            } else {
                activityTbody.innerHTML = ouraData.activity.slice(0, 30).map(d => `
                    <tr>
                        <td>${d.day}</td>
                        <td><span class="score-badge ${getScoreClass(d.score)}">${d.score || '--'}</span></td>
                        <td>${d.steps?.toLocaleString() || '--'}</td>
                        <td>${d.activeCalories || '--'}</td>
                        <td>${d.totalCalories || '--'}</td>
                        <td>${d.equivalentWalkingDistance ? (d.equivalentWalkingDistance / 1000).toFixed(1) + ' km' : '--'}</td>
                        <td>${formatDuration(d.highActivityTime)}</td>
                        <td>${formatDuration(d.mediumActivityTime)}</td>
                    </tr>
                `).join('');
            }
        }

        // ============================================
        // Cronometer/Food Functions
        // ============================================
        async function checkCronometerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/cronometer/status`);
                const status = await response.json();
                
                const statusEl = document.getElementById('foodStatusMessage');
                if (!status.configured || !status.hasCredentials) {
                    statusEl.className = 'status warning';
                    statusEl.textContent = '⚠️ Cronometer credentials not configured';
                } else {
                    statusEl.className = 'status success';
                    const lastSync = status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
                    statusEl.textContent = `✅ Connected (${status.dataCount || 0} records, Last sync: ${lastSync})`;
                }
            } catch (e) {
                console.error('Cronometer status check failed:', e);
            }
        }

        async function loadCronometerData() {
            try {
                const response = await fetch(`${API_BASE}/api/cronometer/data`);
                if (!response.ok) return;
                
                const result = await response.json();
                cronometerData = result.data || result || { dailyNutrition: [], foodServings: [], exercises: [], biometrics: [], notes: [] };
                
                updateFoodUI();
                updateDashboard();
            } catch (e) {
                console.error('Failed to load Cronometer data:', e);
            }
        }

        async function syncCronometerData() {
            const btn = document.getElementById('syncFoodBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '🔄 Syncing...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/cronometer/sync`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    await loadCronometerData();
                    await checkCronometerStatus();
                } else {
                    alert('Sync failed: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Cronometer sync failed:', e);
                alert('Sync failed: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function navigateFoodDate(delta) {
            // Parse foodSelectedDate as local date (not UTC)
            const parts = foodSelectedDate.split('-');
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            date.setDate(date.getDate() + delta);
            
            // Don't allow future dates
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            if (date > today) return;
            
            foodSelectedDate = getLocalDateString(date);
            updateFoodDateDisplay();
            updateFoodUI();
        }

        function updateFoodDateDisplay() {
            const dateEl = document.getElementById('foodSelectedDate');
            const today = getLocalDateString();
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterday = getLocalDateString(yesterdayDate);
            
            if (foodSelectedDate === today) {
                dateEl.textContent = 'Today';
            } else if (foodSelectedDate === yesterday) {
                dateEl.textContent = 'Yesterday';
            } else {
                // Parse as local date for display
                const parts = foodSelectedDate.split('-');
                const displayDate = new Date(parts[0], parts[1] - 1, parts[2]);
                dateEl.textContent = displayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        async function updateFoodUI() {
            const nutrition = cronometerData.dailyNutrition || [];
            const servings = cronometerData.foodServings || [];
            const settings = await getSettings();
            
            // Find selected date's nutrition data (API returns PascalCase properties)
            // Data is sorted descending, so first item is most recent
            const today = getLocalDateString();
            let todayNutrition = nutrition.find(n => n.Date === foodSelectedDate);
            
            // If requesting today but no data, keep showing today with zeros
            // Only fallback to most recent if explicitly navigating to a past date that has no data
            if (!todayNutrition) {
                if (foodSelectedDate === today) {
                    // Keep today selected, show zeros
                    todayNutrition = {};
                } else if (nutrition.length > 0) {
                    // For past dates without data, fallback to most recent
                    todayNutrition = nutrition[0];
                    foodSelectedDate = todayNutrition.Date;
                    updateFoodDateDisplay();
                } else {
                    todayNutrition = {};
                }
            }
            
            // Update summary cards with current/target format
            // API returns PascalCase: Energy, Protein, Carbs, Fat
            const calories = Math.round(todayNutrition.Energy || 0);
            const protein = Math.round(todayNutrition.Protein || 0);
            const carbs = Math.round(todayNutrition.Carbs || 0);
            const fat = Math.round(todayNutrition.Fat || 0);
            
            // Display as current / target
            document.getElementById('food-calories').innerHTML = `${calories}<span class="target">/${settings.calories}</span>`;
            document.getElementById('food-protein').innerHTML = `${protein}g<span class="target">/${settings.protein}g</span>`;
            document.getElementById('food-carbs').innerHTML = `${carbs}g<span class="target">/${settings.carbs}g</span>`;
            document.getElementById('food-fat').innerHTML = `${fat}g<span class="target">/${settings.fat}g</span>`;
            
            // Update details with remaining values
            const caloriesRemaining = settings.calories - calories;
            const proteinRemaining = settings.protein - protein;
            const carbsRemaining = settings.carbs - carbs;
            const fatRemaining = settings.fat - fat;
            
            document.getElementById('food-calories-details').textContent = caloriesRemaining >= 0 
                ? `${caloriesRemaining} remaining` 
                : `${Math.abs(caloriesRemaining)} over`;
            document.getElementById('food-protein-details').textContent = proteinRemaining >= 0 
                ? `${proteinRemaining}g remaining` 
                : `${Math.abs(proteinRemaining)}g over`;
            document.getElementById('food-carbs-details').textContent = carbsRemaining >= 0 
                ? `${carbsRemaining}g remaining` 
                : `${Math.abs(carbsRemaining)}g over`;
            document.getElementById('food-fat-details').textContent = fatRemaining >= 0 
                ? `${fatRemaining}g remaining` 
                : `${Math.abs(fatRemaining)}g over`;
            
            // Update nutrient progress bars (API returns PascalCase)
            updateNutrientBar('fiber', todayNutrition.Fiber, 30, 'g');
            updateNutrientBar('sugar', todayNutrition.Sugars, 50, 'g');
            updateNutrientBar('sodium', todayNutrition.Sodium, 2300, 'mg');
            updateNutrientBar('cholesterol', todayNutrition.Cholesterol, 300, 'mg');
            updateNutrientBar('vitaminD', todayNutrition.VitaminD, 20, 'µg');
            updateNutrientBar('calcium', todayNutrition.Calcium, 1000, 'mg');
            updateNutrientBar('iron', todayNutrition.Iron, 18, 'mg');
            updateNutrientBar('potassium', todayNutrition.Potassium, 3500, 'mg');
            
            // Update macro chart
            updateMacroChart(todayNutrition);
            
            // Update calorie trend chart
            updateCalorieTrendChart(nutrition);
            
            // Update food log table
            updateFoodLog(servings);
        }

        function updateNutrientBar(nutrient, value, target, unit) {
            const percent = value ? Math.min((value / target) * 100, 100) : 0;
            const exceeded = value > target;
            const valueEl = document.getElementById(`nutrient-${nutrient}`);
            const progressEl = document.getElementById(`${nutrient}-progress`);
            const barContainer = progressEl?.closest('.nutrient-bar');
            
            if (valueEl) {
                const exceedMark = exceeded ? ' ⚠️' : '';
                valueEl.textContent = `${(value || 0).toFixed(1)} / ${target} ${unit}${exceedMark}`;
                valueEl.classList.toggle('exceeded', exceeded);
            }
            if (progressEl) {
                progressEl.style.width = `${percent}%`;
                progressEl.classList.toggle('exceeded', exceeded);
            }
            if (barContainer) {
                barContainer.classList.toggle('exceeded', exceeded);
            }
        }

        function updateMacroChart(nutrition) {
            const ctx = document.getElementById('macroChart');
            if (!ctx) return;
            
            // API returns PascalCase properties
            const protein = nutrition.Protein || 0;
            const carbs = nutrition.Carbs || 0;
            const fat = nutrition.Fat || 0;
            const total = protein + carbs + fat;
            
            if (macroChart) {
                macroChart.destroy();
            }
            
            macroChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Protein', 'Carbs', 'Fat'],
                    datasets: [{
                        data: [protein, carbs, fat],
                        backgroundColor: ['#ef4444', '#eab308', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    cutout: '65%'
                }
            });
            
            // Update legend
            const legendEl = document.getElementById('macroLegend');
            if (legendEl) {
                if (total > 0) {
                    legendEl.innerHTML = `
                        <div class="macro-legend-item">
                            <span class="color-dot" style="background: #ef4444"></span>
                            Protein ${((protein / total) * 100).toFixed(0)}% (${protein.toFixed(1)}g)
                        </div>
                        <div class="macro-legend-item">
                            <span class="color-dot" style="background: #eab308"></span>
                            Carbs ${((carbs / total) * 100).toFixed(0)}% (${carbs.toFixed(1)}g)
                        </div>
                        <div class="macro-legend-item">
                            <span class="color-dot" style="background: #22c55e"></span>
                            Fat ${((fat / total) * 100).toFixed(0)}% (${fat.toFixed(1)}g)
                        </div>
                    `;
                } else {
                    legendEl.innerHTML = '<div class="macro-legend-item">No data</div>';
                }
            }
        }

        function updateCalorieTrendChart(nutrition) {
            const ctx = document.getElementById('calorieTrendChart');
            if (!ctx) return;
            
            // Get last 7 days of data (API returns PascalCase)
            const last7 = nutrition.slice(-7);
            const labels = last7.map(n => {
                const d = new Date(n.Date);
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            });
            const calories = last7.map(n => n.Energy || 0);
            
            if (calorieTrendChart) {
                calorieTrendChart.destroy();
            }
            
            calorieTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calories',
                        data: calories,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#f97316',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        // Store current day's servings for modal access
        let currentDayServings = [];

        function updateFoodLog(servings) {
            const tbody = document.getElementById('foodLogBody');
            if (!tbody) return;
            
            // Filter servings for selected date (API returns PascalCase: Day)
            const dayServings = servings.filter(s => {
                const servingDate = s.Day || s.date;
                return servingDate === foodSelectedDate;
            });
            
            // Store for modal access
            currentDayServings = dayServings;
            
            if (dayServings.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="7">
                            <div class="empty-icon">🍽️</div>
                            <p>No food logged for this day</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // API returns PascalCase: FoodName, Category, Amount, Energy, Protein, Carbs, Fat
            tbody.innerHTML = dayServings.map((s, index) => `
                <tr class="clickable-row food-row" data-food-index="${index}">
                    <td>${s.FoodName || s.name || '--'}</td>
                    <td><span class="food-category">${s.Category || '--'}</span></td>
                    <td>${s.Amount || '--'}</td>
                    <td>${Math.round(s.Energy || s.calories || 0)}</td>
                    <td>${(s.Protein || 0).toFixed(1)}</td>
                    <td>${(s.Carbs || 0).toFixed(1)}</td>
                    <td>${(s.Fat || 0).toFixed(1)}</td>
                </tr>
            `).join('');
            
            // Add click handlers
            tbody.querySelectorAll('.food-row').forEach(row => {
                row.addEventListener('click', () => {
                    const index = parseInt(row.dataset.foodIndex);
                    openFoodDetailModal(index);
                });
            });
        }

        // ============================================
        // Sleep Detail Modal Functions
        // ============================================
        async function openSleepDetail(sleepId) {
            try {
                const response = await fetch(`${API_BASE}/api/oura/sleep/${sleepId}`);
                if (!response.ok) {
                    console.error('Failed to fetch sleep details');
                    return;
                }
                
                const data = await response.json();
                // Normalize PascalCase to camelCase
                const sleep = normalizeOuraRecord(data.sleepRecord);
                const contributors = normalizeOuraRecord(data.contributors);
                
                // Populate modal - Hero section
                document.getElementById('modalDate').textContent = sleep.day || '--';
                document.getElementById('modalScore').textContent = data.score || '--';
                document.getElementById('modalTotalSleep').textContent = formatDuration(sleep.totalSleepDuration);
                
                // Restfulness - get from contributors if available
                const restfulness = contributors?.restfulness || '--';
                document.getElementById('modalRestfulness').textContent = restfulness;
                
                // Timing section
                document.getElementById('modalTimeInBed').textContent = `Time in bed: ${formatDuration(sleep.timeInBed)}`;
                document.getElementById('modalEfficiency').textContent = sleep.efficiency ? sleep.efficiency + '%' : '--';
                document.getElementById('modalLatency').textContent = formatDuration(sleep.latency);
                
                // Format bedtime
                const bedStart = sleep.bedtimeStart ? new Date(sleep.bedtimeStart).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '--';
                const bedEnd = sleep.bedtimeEnd ? new Date(sleep.bedtimeEnd).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '--';
                document.getElementById('modalBedtime').textContent = bedStart;
                document.getElementById('modalWakeTime').textContent = bedEnd;
                
                // Sleep stages
                document.getElementById('modalDeep').textContent = formatDuration(sleep.deepSleepDuration);
                document.getElementById('modalLight').textContent = formatDuration(sleep.lightSleepDuration);
                document.getElementById('modalRem').textContent = formatDuration(sleep.remSleepDuration);
                document.getElementById('modalAwake').textContent = formatDuration(sleep.awakeTime);
                
                // Create stage bar
                const total = (sleep.deepSleepDuration || 0) + (sleep.lightSleepDuration || 0) + 
                              (sleep.remSleepDuration || 0) + (sleep.awakeTime || 0);
                if (total > 0) {
                    const deepPct = ((sleep.deepSleepDuration || 0) / total * 100).toFixed(1);
                    const lightPct = ((sleep.lightSleepDuration || 0) / total * 100).toFixed(1);
                    const remPct = ((sleep.remSleepDuration || 0) / total * 100).toFixed(1);
                    const awakePct = ((sleep.awakeTime || 0) / total * 100).toFixed(1);
                    
                    document.getElementById('stageBar').innerHTML = `
                        <div class="stage stage-deep" style="width: ${deepPct}%">${deepPct > 10 ? deepPct + '%' : ''}</div>
                        <div class="stage stage-light" style="width: ${lightPct}%">${lightPct > 10 ? lightPct + '%' : ''}</div>
                        <div class="stage stage-rem" style="width: ${remPct}%">${remPct > 10 ? remPct + '%' : ''}</div>
                        <div class="stage stage-awake" style="width: ${awakePct}%">${awakePct > 10 ? awakePct + '%' : ''}</div>
                    `;
                } else {
                    document.getElementById('stageBar').innerHTML = '<div style="width:100%;text-align:center;color:#666;">No stage data</div>';
                }
                
                // Heart & breath stats
                document.getElementById('modalAvgHR').textContent = sleep.averageHeartRate ? Math.round(sleep.averageHeartRate) : '--';
                document.getElementById('modalLowestHR').textContent = `Lowest: ${sleep.lowestHeartRate ? Math.round(sleep.lowestHeartRate) + ' bpm' : '--'}`;
                document.getElementById('modalHRV').textContent = sleep.averageHrv ? Math.round(sleep.averageHrv) : '--';
                document.getElementById('modalBreath').textContent = sleep.averageBreath ? sleep.averageBreath.toFixed(1) : '--';
                document.getElementById('modalRestless').textContent = `Restless periods: ${sleep.restlessPeriods || '--'}`;
                
                // Contributors
                const contributorsSection = document.getElementById('contributorsSection');
                const contributorsList = document.getElementById('contributorsList');
                
                if (contributors) {
                    contributorsSection.style.display = 'block';
                    const contributorNames = {
                        deepSleep: 'Deep Sleep',
                        efficiency: 'Efficiency',
                        latency: 'Latency',
                        remSleep: 'REM Sleep',
                        restfulness: 'Restfulness',
                        timing: 'Timing',
                        totalSleep: 'Total Sleep'
                    };
                    
                    contributorsList.innerHTML = Object.entries(contributors)
                        .filter(([key, value]) => value !== null && value !== undefined)
                        .map(([key, value]) => `
                            <div class="contributor-item">
                                <span class="name">${contributorNames[key] || key}</span>
                                <span class="value">${value}</span>
                            </div>
                        `).join('');
                } else {
                    contributorsSection.style.display = 'none';
                }
                
                // Show modal
                document.getElementById('sleepModal').classList.add('active');
                document.body.style.overflow = 'hidden';
                
            } catch (e) {
                console.error('Error loading sleep details:', e);
            }
        }

        function closeSleepModal(event) {
            // Only prevent close if clicking inside modal content (not backdrop)
            if (event && event.target.closest('.modal-content')) return;
            document.getElementById('sleepModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ============================================
        // Measurement Detail Modal Functions
        // ============================================
        function showMeasurementDetail(index) {
            const measurement = picoocData[index];
            if (!measurement) return;

            // Helper to format decimal values
            const fmt = (v, decimals = 1) => v != null && v !== 0 ? parseFloat(v).toFixed(decimals) : '--';

            // Helper to get value with fallback and formatting
            const getValue = (m, ...keys) => {
                for (const key of keys) {
                    if (m[key] !== undefined && m[key] !== null && m[key] !== 0) return fmt(m[key]);
                }
                return '--';
            };

            const getNumValue = (m, ...keys) => {
                for (const key of keys) {
                    if (m[key] !== undefined && m[key] !== null && m[key] !== 0) return parseFloat(m[key]);
                }
                return 0;
            };

            // Populate modal
            const date = new Date(measurement.date || measurement.Date);
            document.getElementById('measurementModalDate').textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('measurementWeight').textContent = getValue(measurement, 'weight', 'Weight');
            document.getElementById('measurementBMI').textContent = getValue(measurement, 'bmi', 'BMI');
            document.getElementById('measurementBodyFat').textContent = getValue(measurement, 'bodyFat', 'BodyFat');
            document.getElementById('measurementBodyFatHero').textContent = getValue(measurement, 'bodyFat', 'BodyFat');
            document.getElementById('measurementMuscle').textContent = getValue(measurement, 'skeletalMuscleMass', 'SkeletalMuscleMass');
            document.getElementById('measurementWater').textContent = getValue(measurement, 'bodyWater', 'BodyWater');
            document.getElementById('measurementBone').textContent = getValue(measurement, 'boneMass', 'BoneMass');
            document.getElementById('measurementMetabolicAge').textContent = getValue(measurement, 'metabolicAge', 'MetabolicAge');
            document.getElementById('measurementVisceralFat').textContent = getValue(measurement, 'visceralFat', 'VisceralFat');
            document.getElementById('measurementBMR').textContent = getValue(measurement, 'basalMetabolism', 'BasalMetabolism');

            // Body Fat status
            const bodyFatVal = getNumValue(measurement, 'bodyFat', 'BodyFat');
            const bodyFatStatusEl = document.getElementById('bodyFatStatus');
            if (bodyFatVal > 0) {
                // General ranges (varies by age/gender, using male averages)
                if (bodyFatVal < 14) { bodyFatStatusEl.textContent = '💪 Athletic'; bodyFatStatusEl.style.color = '#3b82f6'; }
                else if (bodyFatVal < 20) { bodyFatStatusEl.textContent = '✅ Fit'; bodyFatStatusEl.style.color = '#22c55e'; }
                else if (bodyFatVal < 25) { bodyFatStatusEl.textContent = '👍 Average'; bodyFatStatusEl.style.color = '#84cc16'; }
                else { bodyFatStatusEl.textContent = '⚠️ Above Avg'; bodyFatStatusEl.style.color = '#f59e0b'; }
            } else {
                bodyFatStatusEl.textContent = '%';
                bodyFatStatusEl.style.color = '#888';
            }

            // BMI status with color
            const bmi = getNumValue(measurement, 'bmi', 'BMI');
            const bmiStatusEl = document.getElementById('measurementBMIStatus');
            let bmiStatus = '--', bmiColor = '#888';
            if (bmi > 0) {
                if (bmi < 18.5) { bmiStatus = '⚠️ Underweight'; bmiColor = '#f59e0b'; }
                else if (bmi < 25) { bmiStatus = '✅ Normal'; bmiColor = '#22c55e'; }
                else if (bmi < 30) { bmiStatus = '⚠️ Overweight'; bmiColor = '#f59e0b'; }
                else { bmiStatus = '🔴 Obese'; bmiColor = '#ef4444'; }
            }
            bmiStatusEl.textContent = bmiStatus;
            bmiStatusEl.style.color = bmiColor;

            // Visceral fat status
            const visceralFat = getNumValue(measurement, 'visceralFat', 'VisceralFat');
            const visceralStatusEl = document.getElementById('visceralStatus');
            if (visceralFat > 0) {
                if (visceralFat <= 9) { visceralStatusEl.textContent = '✅ Healthy'; visceralStatusEl.style.color = '#22c55e'; }
                else if (visceralFat <= 14) { visceralStatusEl.textContent = '⚠️ High'; visceralStatusEl.style.color = '#f59e0b'; }
                else { visceralStatusEl.textContent = '🔴 Very High'; visceralStatusEl.style.color = '#ef4444'; }
            } else {
                visceralStatusEl.textContent = 'level';
                visceralStatusEl.style.color = '#888';
            }

            // Composition bars (approximate percentages for visual)
            const weight = getNumValue(measurement, 'weight', 'Weight');
            const muscle = getNumValue(measurement, 'skeletalMuscleMass', 'SkeletalMuscleMass');
            const bodyFat = getNumValue(measurement, 'bodyFat', 'BodyFat');
            const water = getNumValue(measurement, 'bodyWater', 'BodyWater');
            const bone = getNumValue(measurement, 'boneMass', 'BoneMass');

            // Set bar widths (scaled for visual appeal)
            document.getElementById('muscleBar').style.width = weight > 0 ? Math.min((muscle / weight) * 250, 100) + '%' : '0%';
            document.getElementById('fatBar').style.width = Math.min(bodyFat * 2, 100) + '%';
            document.getElementById('waterBar').style.width = Math.min(water, 100) + '%';
            document.getElementById('boneBar').style.width = weight > 0 ? Math.min((bone / weight) * 500, 100) + '%' : '0%';

            // Show modal
            document.getElementById('measurementModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeMeasurementModal(event) {
            // Only prevent close if clicking inside modal content (not backdrop)
            if (event && event.target.closest('.modal-content')) return;
            document.getElementById('measurementModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ============================================
        // Settings Modal Functions
        // ============================================
        
        // Default settings
        const defaultSettings = {
            height: 175,
            calories: 2000,
            protein: 150,
            carbs: 250,
            fat: 65
        };
        
        // Cache for settings to avoid multiple API calls
        let cachedSettings = null;
        
        async function getSettings() {
            // Return cached settings if available
            if (cachedSettings) {
                return { ...defaultSettings, ...cachedSettings };
            }
            
            // Try to load from API
            try {
                const response = await fetch(`${API_BASE}/settings`);
                if (response.ok) {
                    const data = await response.json();
                    cachedSettings = data;
                    return { ...defaultSettings, ...data };
                }
            } catch (e) {
                console.warn('Failed to load settings from API, using localStorage fallback');
            }
            
            // Fallback to localStorage
            const stored = localStorage.getItem('healthAggregatorSettings');
            if (stored) {
                return { ...defaultSettings, ...JSON.parse(stored) };
            }
            return { ...defaultSettings };
        }
        
        async function saveSettingsToStorage(settings) {
            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    cachedSettings = settings;
                    // Also save to localStorage as backup
                    localStorage.setItem('healthAggregatorSettings', JSON.stringify(settings));
                    return true;
                } else {
                    throw new Error('API save failed');
                }
            } catch (e) {
                console.warn('Failed to save settings to API, saving to localStorage only');
                localStorage.setItem('healthAggregatorSettings', JSON.stringify(settings));
                return false;
            }
        }
        
        async function openSettingsModal() {
            const settings = await getSettings();
            
            // Populate form with current settings
            document.getElementById('settingHeight').value = settings.height || '';
            document.getElementById('settingCalories').value = settings.calories || '';
            document.getElementById('settingProtein').value = settings.protein || '';
            document.getElementById('settingCarbs').value = settings.carbs || '';
            document.getElementById('settingFat').value = settings.fat || '';
            
            // Show modal
            document.getElementById('settingsModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeSettingsModal(event) {
            if (event && event.target.closest('.settings-modal')) return;
            document.getElementById('settingsModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        async function saveSettings() {
            const settings = {
                height: parseInt(document.getElementById('settingHeight').value) || defaultSettings.height,
                calories: parseInt(document.getElementById('settingCalories').value) || defaultSettings.calories,
                protein: parseInt(document.getElementById('settingProtein').value) || defaultSettings.protein,
                carbs: parseInt(document.getElementById('settingCarbs').value) || defaultSettings.carbs,
                fat: parseInt(document.getElementById('settingFat').value) || defaultSettings.fat
            };
            
            const saved = await saveSettingsToStorage(settings);
            closeSettingsModal();
            
            // Refresh the Food tab display if it's active
            if (document.querySelector('[data-tab="food"]')?.classList.contains('active')) {
                displayCronometerData();
            }
            
            // Show success notification
            showNotification(saved ? 'Settings saved to cloud!' : 'Settings saved locally', saved ? 'success' : 'info');
        }
        
        function applyPreset(preset) {
            // Get weight from Picooc data (most recent measurement)
            let weight = 70; // default
            if (picoocData && picoocData.length > 0) {
                const sorted = [...picoocData].sort((a, b) => new Date(b.date || b.Date) - new Date(a.date || a.Date));
                weight = sorted[0].weight || sorted[0].Weight || 70;
            }
            
            let calories, protein, carbs, fat;
            
            switch (preset) {
                case 'maintenance':
                    // Moderate activity: ~30 kcal per kg
                    calories = Math.round(weight * 30);
                    protein = Math.round(weight * 1.8);    // 1.8g per kg
                    fat = Math.round(calories * 0.25 / 9); // 25% of calories
                    carbs = Math.round((calories - protein * 4 - fat * 9) / 4);
                    break;
                case 'cutting':
                    // Deficit: ~24 kcal per kg
                    calories = Math.round(weight * 24);
                    protein = Math.round(weight * 2.2);    // Higher protein for muscle preservation
                    fat = Math.round(calories * 0.25 / 9); // 25% of calories
                    carbs = Math.round((calories - protein * 4 - fat * 9) / 4);
                    break;
                case 'bulking':
                    // Surplus: ~35 kcal per kg
                    calories = Math.round(weight * 35);
                    protein = Math.round(weight * 2.0);    // 2g per kg
                    fat = Math.round(calories * 0.25 / 9); // 25% of calories
                    carbs = Math.round((calories - protein * 4 - fat * 9) / 4);
                    break;
            }
            
            document.getElementById('settingCalories').value = calories;
            document.getElementById('settingProtein').value = protein;
            document.getElementById('settingCarbs').value = carbs;
            document.getElementById('settingFat').value = fat;
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#22c55e' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============================================
        // Food Detail Modal Functions
        // ============================================
        function openFoodDetailModal(index) {
            const food = currentDayServings[index];
            if (!food) return;
            
            // Populate modal fields
            document.getElementById('foodModalDate').textContent = food.Day || food.date || '--';
            document.getElementById('foodModalName').textContent = food.FoodName || food.name || '--';
            document.getElementById('foodModalCategory').textContent = food.Category || '--';
            document.getElementById('foodModalAmount').textContent = food.Amount || '--';
            document.getElementById('foodModalGroup').textContent = food.Group || 'Uncategorized';
            
            // Nutrition values
            document.getElementById('foodModalCalories').textContent = Math.round(food.Energy || food.calories || 0) + ' kcal';
            document.getElementById('foodModalProtein').textContent = (food.Protein || 0).toFixed(1) + 'g';
            document.getElementById('foodModalCarbs').textContent = (food.Carbs || 0).toFixed(1) + 'g';
            document.getElementById('foodModalFat').textContent = (food.Fat || 0).toFixed(1) + 'g';
            
            // Additional nutrients
            document.getElementById('foodModalFiber').textContent = food.Fiber != null ? (food.Fiber).toFixed(1) + 'g' : '--';
            document.getElementById('foodModalSugar').textContent = food.Sugars != null ? (food.Sugars).toFixed(1) + 'g' : '--';
            document.getElementById('foodModalSodium').textContent = food.Sodium != null ? Math.round(food.Sodium) + 'mg' : '--';
            
            // Show modal
            document.getElementById('foodDetailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFoodDetailModal(event) {
            if (event && event.target.closest('.modal-content')) return;
            document.getElementById('foodDetailModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSleepModal();
                closeMeasurementModal();
                closeFoodDetailModal();
                closeSettingsModal();
            }
        });
    </script>
</body>
</html>




