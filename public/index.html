<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Aggregator - Picooc Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            color: #00d4ff;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.1rem;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.green { background: #00ff88; }
        .status-dot.red { background: #ff4444; }
        .status-dot.yellow { background: #ffaa00; }

        .btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.syncing {
            background: linear-gradient(135deg, #666 0%, #444 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 212, 255, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card h3 {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .stat-card .unit {
            font-size: 1.2rem;
            color: #666;
        }

        .stat-card .details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.85rem;
        }

        .stat-card .details span {
            color: #666;
        }

        .stat-card .details strong {
            color: #aaa;
        }

        .charts-section {
            margin-bottom: 30px;
        }

        .charts-section h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .data-table-section {
            margin-top: 30px;
        }

        .data-table-section h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-scroll {
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-data h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #888;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #00ff88;
        }

        .toast.error {
            border-left: 4px solid #ff4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .metric-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .metric-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .metric-btn:hover {
            border-color: rgba(0, 212, 255, 0.5);
            color: #00d4ff;
        }

        .metric-btn.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }

            .stat-card .value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèãÔ∏è Health Aggregator</h1>
            <p>Track your body composition data from Picooc smart scale</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Checking status...</span>
            </div>
            <div class="status-item">
                <span>Last sync: <strong id="lastSync">Never</strong></span>
            </div>
            <button class="btn" id="syncBtn" onclick="syncData()">
                <span id="syncIcon">üîÑ</span>
                <span id="syncText">Sync Now</span>
            </button>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Weight</h3>
                <div class="value" id="currentWeight">--</div>
                <div class="unit">kg</div>
                <div class="details" id="weightDetails">
                    <div><span>Min:</span> <strong>--</strong></div>
                    <div><span>Avg:</span> <strong>--</strong></div>
                    <div><span>Max:</span> <strong>--</strong></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>Body Fat</h3>
                <div class="value" id="currentBodyFat">--</div>
                <div class="unit">%</div>
                <div class="details" id="bodyFatDetails">
                    <div><span>Min:</span> <strong>--</strong></div>
                    <div><span>Avg:</span> <strong>--</strong></div>
                    <div><span>Max:</span> <strong>--</strong></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>BMI</h3>
                <div class="value" id="currentBMI">--</div>
                <div class="unit">index</div>
                <div class="details" id="bmiDetails">
                    <div><span>Min:</span> <strong>--</strong></div>
                    <div><span>Avg:</span> <strong>--</strong></div>
                    <div><span>Max:</span> <strong>--</strong></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>Total Measurements</h3>
                <div class="value" id="totalMeasurements">--</div>
                <div class="unit">records</div>
                <div class="details" id="measurementDetails">
                    <div><span>First:</span> <strong id="firstDate">--</strong></div>
                    <div><span>Last:</span> <strong id="lastDate">--</strong></div>
                    <div></div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <h2>üìä Trends</h2>
            <div class="metric-selector">
                <button class="metric-btn active" data-metric="Weight" onclick="toggleMetric(this)">Weight</button>
                <button class="metric-btn active" data-metric="BodyFat" onclick="toggleMetric(this)">Body Fat</button>
                <button class="metric-btn" data-metric="BMI" onclick="toggleMetric(this)">BMI</button>
                <button class="metric-btn" data-metric="MuscleMass" onclick="toggleMetric(this)">Muscle Mass</button>
                <button class="metric-btn" data-metric="BodyWater" onclick="toggleMetric(this)">Body Water</button>
                <button class="metric-btn" data-metric="BoneMass" onclick="toggleMetric(this)">Bone Mass</button>
                <button class="metric-btn" data-metric="VisceralFat" onclick="toggleMetric(this)">Visceral Fat</button>
            </div>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table-section">
            <h2>üìã Measurement History</h2>
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Weight (kg)</th>
                                <th>Body Fat (%)</th>
                                <th>BMI</th>
                                <th>Muscle Mass (kg)</th>
                                <th>Body Water (%)</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <tr>
                                <td colspan="6" class="no-data">
                                    <h3>No data yet</h3>
                                    <p>Click "Sync Now" to fetch your data from Picooc</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let healthData = [];
        let mainChart = null;
        let activeMetrics = ['Weight', 'BodyFat'];

        const metricColors = {
            Weight: { border: '#00d4ff', background: 'rgba(0, 212, 255, 0.1)' },
            BodyFat: { border: '#ff6b6b', background: 'rgba(255, 107, 107, 0.1)' },
            BMI: { border: '#ffd93d', background: 'rgba(255, 217, 61, 0.1)' },
            MuscleMass: { border: '#6bcb77', background: 'rgba(107, 203, 119, 0.1)' },
            BodyWater: { border: '#4d96ff', background: 'rgba(77, 150, 255, 0.1)' },
            BoneMass: { border: '#c9b1ff', background: 'rgba(201, 177, 255, 0.1)' },
            VisceralFat: { border: '#ff9f43', background: 'rgba(255, 159, 67, 0.1)' }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            loadData();
        });

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');

                if (status.configured) {
                    statusDot.className = 'status-dot green';
                    statusText.textContent = `Connected (${status.dataCount} records)`;
                } else if (!status.hasCredentials) {
                    statusDot.className = 'status-dot red';
                    statusText.textContent = 'Credentials not configured';
                } else if (!status.hasBinary) {
                    statusDot.className = 'status-dot yellow';
                    statusText.textContent = 'SmartScaleConnect binary missing';
                }
            } catch (error) {
                console.error('Status check failed:', error);
            }
        }

        async function loadData() {
            try {
                const response = await fetch('/api/data');
                healthData = await response.json();
                updateUI();
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        async function syncData() {
            const btn = document.getElementById('syncBtn');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');

            btn.disabled = true;
            btn.classList.add('syncing');
            icon.innerHTML = '<span class="loading"></span>';
            text.textContent = 'Syncing...';

            try {
                const response = await fetch('/api/sync', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    healthData = result.data;
                    updateUI();
                    showToast(`Synced successfully! ${result.count} records`, 'success');
                    document.getElementById('lastSync').textContent = new Date().toLocaleString();
                } else {
                    showToast(`Sync failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`Sync error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('syncing');
                icon.textContent = 'üîÑ';
                text.textContent = 'Sync Now';
                checkStatus();
            }
        }

        function updateUI() {
            updateStats();
            updateChart();
            updateTable();
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                if (stats.weight) {
                    document.getElementById('currentWeight').textContent = stats.weight.current?.toFixed(1) || '--';
                    document.getElementById('weightDetails').innerHTML = `
                        <div><span>Min:</span> <strong>${stats.weight.min?.toFixed(1)}</strong></div>
                        <div><span>Avg:</span> <strong>${stats.weight.avg}</strong></div>
                        <div><span>Max:</span> <strong>${stats.weight.max?.toFixed(1)}</strong></div>
                    `;
                }

                if (stats.bodyFat) {
                    document.getElementById('currentBodyFat').textContent = stats.bodyFat.current?.toFixed(1) || '--';
                    document.getElementById('bodyFatDetails').innerHTML = `
                        <div><span>Min:</span> <strong>${stats.bodyFat.min?.toFixed(1)}</strong></div>
                        <div><span>Avg:</span> <strong>${stats.bodyFat.avg}</strong></div>
                        <div><span>Max:</span> <strong>${stats.bodyFat.max?.toFixed(1)}</strong></div>
                    `;
                }

                if (stats.bmi) {
                    document.getElementById('currentBMI').textContent = stats.bmi.current?.toFixed(1) || '--';
                    document.getElementById('bmiDetails').innerHTML = `
                        <div><span>Min:</span> <strong>${stats.bmi.min?.toFixed(1)}</strong></div>
                        <div><span>Avg:</span> <strong>${stats.bmi.avg}</strong></div>
                        <div><span>Max:</span> <strong>${stats.bmi.max?.toFixed(1)}</strong></div>
                    `;
                }

                document.getElementById('totalMeasurements').textContent = stats.totalMeasurements || 0;
                document.getElementById('firstDate').textContent = stats.firstMeasurement 
                    ? new Date(stats.firstMeasurement).toLocaleDateString() : '--';
                document.getElementById('lastDate').textContent = stats.lastMeasurement 
                    ? new Date(stats.lastMeasurement).toLocaleDateString() : '--';
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }

        function updateChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');

            if (mainChart) {
                mainChart.destroy();
            }

            if (healthData.length === 0) return;

            const sortedData = [...healthData].sort((a, b) => 
                new Date(a.Date || a.date) - new Date(b.Date || b.date)
            );

            const datasets = activeMetrics.map(metric => {
                const colors = metricColors[metric];
                return {
                    label: metric.replace(/([A-Z])/g, ' $1').trim(),
                    data: sortedData.map(d => ({
                        x: new Date(d.Date || d.date),
                        y: d[metric] || null
                    })).filter(d => d.y !== null && d.y > 0),
                    borderColor: colors.border,
                    backgroundColor: colors.background,
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                };
            });

            mainChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#888'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#00d4ff',
                            bodyColor: '#fff',
                            padding: 12,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#666'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#666'
                            }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('dataTable');

            if (healthData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">
                            <h3>No data yet</h3>
                            <p>Click "Sync Now" to fetch your data from Picooc</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = healthData.map(d => {
                const date = new Date(d.Date || d.date);
                return `
                    <tr>
                        <td>${date.toLocaleString()}</td>
                        <td>${d.Weight?.toFixed(1) || '--'}</td>
                        <td>${d.BodyFat?.toFixed(1) || '--'}</td>
                        <td>${d.BMI?.toFixed(1) || '--'}</td>
                        <td>${d.MuscleMass?.toFixed(1) || '--'}</td>
                        <td>${d.BodyWater?.toFixed(1) || '--'}</td>
                    </tr>
                `;
            }).join('');
        }

        function toggleMetric(btn) {
            const metric = btn.dataset.metric;
            btn.classList.toggle('active');

            if (btn.classList.contains('active')) {
                if (!activeMetrics.includes(metric)) {
                    activeMetrics.push(metric);
                }
            } else {
                activeMetrics = activeMetrics.filter(m => m !== metric);
            }

            updateChart();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 4000);
        }
    </script>
</body>
</html>
